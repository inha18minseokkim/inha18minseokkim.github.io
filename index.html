---
layout: default
---
<section class="hero">
  <div class="container">
    <p class="hero-greeting">안녕하세요,</p>
    <h1 class="hero-title">minseokkim<span class="dot">.</span></h1>
    <p class="hero-desc">개발하면서 공부하고 경험한 것들을 정리하는 공간입니다.</p>
  </div>
</section>

<section class="posts-section">
  <div class="container">

    {% if site.posts.size > 0 %}

    <div class="posts-layout">

      <!-- 카테고리 사이드바 (JS로 동적 생성) -->
      <aside class="category-sidebar" id="categorySidebar"></aside>

      <!-- 메인 콘텐츠 -->
      <div class="posts-main">
        <h2 class="section-title">전체 글</h2>

        <!-- 태그 필터 -->
        <div class="tag-filter-wrapper">
          <div class="tag-filter-header">
            <button class="tag-toggle-btn" id="tagToggleBtn">
              <span class="tag-toggle-icon">▶</span> 태그 필터
            </button>
            <div class="tag-sort-btns">
              <button class="tag-sort-btn active" data-sort="count">인기순</button>
              <button class="tag-sort-btn" data-sort="name">이름순</button>
            </div>
          </div>
          <div class="tag-filter collapsed" id="tagFilterContent">
            <button class="tag-filter-btn active" data-tag="all">전체</button>
            {% for tag in site.tags %}
            <button class="tag-filter-btn" data-tag="{{ tag[0] }}" data-count="{{ tag[1] | size }}">{% if tag[0] == "메이플" %}<img src="/assets/icons/메이플.ico" alt="" class="tag-icon">{% endif %}{{ tag[0] }}</button>
            {% endfor %}
          </div>
        </div>

        <!-- 날짜 범위 필터 -->
        <div class="date-filter">
          <div class="date-filter-input-wrap">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor">
              <path d="M4.75 0a.75.75 0 0 1 .75.75V2h5V.75a.75.75 0 0 1 1.5 0V2h1.25A1.75 1.75 0 0 1 15 3.75v9.5A1.75 1.75 0 0 1 13.25 15H2.75A1.75 1.75 0 0 1 1 13.25v-9.5A1.75 1.75 0 0 1 2.75 2H4V.75A.75.75 0 0 1 4.75 0ZM2.5 7.5v5.75c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25V7.5Z"/>
            </svg>
            <input type="text" id="dateRangePicker" class="date-filter-input" placeholder="날짜 범위 선택" readonly>
          </div>
          <button class="date-clear-btn" id="dateClearBtn">✕ 초기화</button>
        </div>

        <p class="filter-status" id="filterStatus"></p>

        <ul class="post-list">
          {% for post in site.posts %}
          <li class="post-item" data-tags="{{ post.tags | join: ',' }}" data-date="{{ post.date | date: '%Y-%m-%d' }}" data-category="{{ post.categories | join: ',' | default: '기타' }}" data-title="{{ post.title | downcase }}" data-excerpt="{{ post.excerpt | strip_html | truncate: 300 | downcase }}">
            <a href="{{ post.url | relative_url }}" class="post-link">
              <div class="post-meta">
                <time class="post-date">{{ post.date | date: "%Y. %m. %d" }}</time>
                {% if post.tags %}
                <div class="post-tags">
                  {% for tag in post.tags %}
                  <span class="tag">{{ tag }}</span>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
              <h2 class="post-title">{{ post.title }}</h2>
              <p class="post-excerpt">{{ post.excerpt | strip_html | truncate: 160 }}</p>
            </a>
          </li>
          {% endfor %}
        </ul>
      </div><!-- .posts-main -->

    </div><!-- .posts-layout -->

    {% else %}
    <div class="empty-state">
      <p>아직 작성된 글이 없습니다.</p>
    </div>
    {% endif %}
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ── 태그 토글 & 정렬 ────────────────────────────────────────────────────────
  const tagFilter      = document.querySelector('.tag-filter');
  const tagToggleBtn   = document.getElementById('tagToggleBtn');
  const tagFilterContent = document.getElementById('tagFilterContent');
  const tagSortBtns    = document.querySelectorAll('.tag-sort-btn');
  const tagBtns        = Array.from(tagFilter.querySelectorAll('.tag-filter-btn[data-count]'));

  // 초기 정렬: 인기순
  function sortTagsByCount() {
    tagBtns.sort((a, b) => parseInt(b.dataset.count) - parseInt(a.dataset.count));
    tagBtns.forEach(btn => tagFilter.appendChild(btn));
  }

  function sortTagsByName() {
    tagBtns.sort((a, b) => a.dataset.tag.localeCompare(b.dataset.tag, 'ko'));
    tagBtns.forEach(btn => tagFilter.appendChild(btn));
  }

  sortTagsByCount(); // 초기 정렬

  // 토글 버튼 클릭
  tagToggleBtn.addEventListener('click', function() {
    const isCollapsed = tagFilterContent.classList.contains('collapsed');
    if (isCollapsed) {
      tagFilterContent.classList.remove('collapsed');
      this.classList.add('expanded');
    } else {
      tagFilterContent.classList.add('collapsed');
      this.classList.remove('expanded');
    }
  });

  // 정렬 버튼 클릭
  tagSortBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      tagSortBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');

      if (this.dataset.sort === 'count') {
        sortTagsByCount();
      } else if (this.dataset.sort === 'name') {
        sortTagsByName();
      }
    });
  });

  const filterBtns     = document.querySelectorAll('.tag-filter-btn');
  const allTagBtn      = document.querySelector('.tag-filter-btn[data-tag="all"]');
  const postItems      = document.querySelectorAll('.post-item');
  const filterStatus   = document.getElementById('filterStatus');
  const dateClearBtn   = document.getElementById('dateClearBtn');
  const sidebar        = document.getElementById('categorySidebar');
  const searchInput    = document.getElementById('headerSearchInput');

  let selectedTags    = new Set();
  let dateFrom        = null;
  let dateTo          = null;
  let selectedCatPath = null; // null=전체 | "기술" | "기술,Spring" | ...
  let searchQuery     = '';

  // ── 유틸 ──────────────────────────────────────────────────────────────────
  // data-category 값("재테크,주식")을 HTML id에 안전하게 변환
  function safeId(key) {
    return 'cc-' + (key || 'all').replace(/[^a-zA-Z0-9가-힣]/g, '_');
  }

  // ── 카테고리 트리 빌드 ────────────────────────────────────────────────────
  // 대분류 고정 순서 (없는 분류는 렌더 스킵)
  const TOP_ORDER  = ['기술', '실무경험', '재테크', '기타'];
  // 트리 노드: { label, path, children: Map<label, node> }
  const treeRoot   = { label: '', path: '', children: new Map() };

  postItems.forEach(item => {
    const raw   = (item.dataset.category || '기타').trim();
    const parts = raw.split(',').map(s => s.trim()).filter(Boolean);
    if (!parts.length) parts.push('기타');

    let node = treeRoot;
    parts.forEach((label, i) => {
      const path = parts.slice(0, i + 1).join(',');
      if (!node.children.has(label))
        node.children.set(label, { label, path, children: new Map() });
      node = node.children.get(label);
    });
  });

  // ── 사이드바 렌더링 (재귀) ────────────────────────────────────────────────
  function renderNode(node, depth) {
    const hasCh    = node.children.size > 0;
    const subClass = depth > 1 ? ' cat-sub' : '';
    const arrow    = hasCh
      ? '<span class="cat-arrow">▶</span>'
      : '<span class="cat-indent"></span>';

    // 자식 노드를 한글 로케일 기준으로 정렬
    const sorted = [...node.children.values()]
      .sort((a, b) => a.label.localeCompare(b.label, 'ko'));

    return `<div class="cat-group" data-path="${node.path}" data-depth="${depth}">
      <button class="category-btn${subClass}" data-cat="${node.path}">
        ${arrow}<span class="cat-label">${node.label}</span>
        <span class="category-count" id="${safeId(node.path)}"></span>
      </button>
      ${hasCh ? `<div class="cat-children">${sorted.map(c => renderNode(c, depth + 1)).join('')}</div>` : ''}
    </div>`;
  }

  function buildSidebar() {
    let html = `<p class="category-sidebar-title">카테고리</p>
      <button class="category-btn active" data-cat="">
        <span class="cat-indent"></span><span class="cat-label">전체</span>
        <span class="category-count" id="${safeId('all')}"></span>
      </button>`;

    // 고정 순서로 대분류 렌더
    TOP_ORDER.forEach(top => {
      if (treeRoot.children.has(top)) html += renderNode(treeRoot.children.get(top), 1);
    });
    // TOP_ORDER에 없는 추가 대분류
    treeRoot.children.forEach((node, label) => {
      if (!TOP_ORDER.includes(label)) html += renderNode(node, 1);
    });

    sidebar.innerHTML = html;
    attachCategoryListeners();
  }

  // ── 카테고리 클릭 핸들러 ──────────────────────────────────────────────────
  function attachCategoryListeners() {
    sidebar.querySelectorAll('.category-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const path = this.dataset.cat;
        selectedCatPath = path || null;

        // active 클래스 갱신
        sidebar.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        // 클릭된 경로의 조상 그룹은 expand, 나머지는 collapse
        sidebar.querySelectorAll('.cat-group').forEach(g => {
          const gPath = g.dataset.path || '';
          if (!path) {
            g.classList.remove('expanded');
          } else {
            const pParts = path.split(',');
            const gParts = gPath.split(',');
            const isAncestorOrSelf =
              gParts.length <= pParts.length &&
              pParts.slice(0, gParts.length).join(',') === gPath;
            g.classList.toggle('expanded', isAncestorOrSelf && g.querySelector('.cat-children') !== null);
          }
        });

        applyFilter();
      });
    });
  }

  // ── 카테고리 매칭 ─────────────────────────────────────────────────────────
  // selectedCatPath가 "기술" → "기술,*" 포스트 모두 매칭
  // selectedCatPath가 "기술,Spring" → "기술,Spring,*" 포스트만 매칭
  function catMatch(item) {
    if (!selectedCatPath) return true;
    const parts    = (item.dataset.category || '기타').split(',').map(s => s.trim());
    const selParts = selectedCatPath.split(',');
    return selParts.length <= parts.length && selParts.every((s, i) => s === parts[i]);
  }

  // ── 카운트 업데이트 ───────────────────────────────────────────────────────
  // tagDate 조건만 반영한 카운트 (카테고리 선택과 무관하게 갯수 표시)
  function updateCategoryCounts(matchFn) {
    const counts = new Map([['all', 0]]);
    postItems.forEach(item => {
      if (!matchFn(item)) return;
      counts.set('all', counts.get('all') + 1);
      const parts = (item.dataset.category || '기타').split(',').map(s => s.trim()).filter(Boolean);
      parts.forEach((_, i) => {
        const prefix = parts.slice(0, i + 1).join(',');
        counts.set(prefix, (counts.get(prefix) || 0) + 1);
      });
    });
    counts.forEach((n, key) => {
      const el = document.getElementById(safeId(key));
      if (el) el.textContent = n;
    });
  }

  // ── 태그 + 날짜 + 검색어 매칭 ────────────────────────────────────────────
  function tagDateMatch(item) {
    const tags   = item.dataset.tags ? item.dataset.tags.split(',') : [];
    const tagOk  = selectedTags.size === 0 || tags.some(t => selectedTags.has(t));
    const d      = new Date(item.dataset.date);
    const dateOk = (!dateFrom && !dateTo) || (dateFrom && dateTo && d >= dateFrom && d <= dateTo);

    // 검색어 매칭 (제목 + 내용)
    let searchOk = true;
    if (searchQuery) {
      const title   = item.dataset.title || '';
      const excerpt = item.dataset.excerpt || '';
      searchOk = title.includes(searchQuery) || excerpt.includes(searchQuery);
    }

    return tagOk && dateOk && searchOk;
  }

  // ── 필터 적용 ─────────────────────────────────────────────────────────────
  function applyFilter() {
    let cnt = 0;
    postItems.forEach(item => {
      const show = tagDateMatch(item) && catMatch(item);
      item.style.display = show ? '' : 'none';
      if (show) cnt++;
    });

    updateCategoryCounts(tagDateMatch);

    const tagPart    = selectedTags.size > 0
      ? [...selectedTags].map(t => `"${t}"`).join(', ') + ' 태그' : '';
    const datePart   = (dateFrom && dateTo)
      ? `${fp.formatDate(dateFrom, 'Y.m.d')} ~ ${fp.formatDate(dateTo, 'Y.m.d')}` : '';
    const catPart    = selectedCatPath
      ? selectedCatPath.split(',').join(' > ') : '';
    const searchPart = searchQuery ? `"${searchQuery}" 검색` : '';
    const parts      = [searchPart, catPart, tagPart, datePart].filter(Boolean);

    filterStatus.textContent = parts.length ? `${parts.join(' · ')}: ${cnt}개의 글` : '';
    allTagBtn.classList.toggle('active', parts.length === 0);
    dateClearBtn.style.display = (dateFrom && dateTo) ? 'inline-block' : 'none';
  }

  // ── Flatpickr ─────────────────────────────────────────────────────────────
  const fp = flatpickr('#dateRangePicker', {
    mode: 'range',
    dateFormat: 'Y.m.d',
    locale: {
      rangeSeparator: ' ~ ',
      weekdays: { shorthand: ['일','월','화','수','목','금','토'], longhand: ['일','월','화','수','목','금','토'] },
      months: {
        shorthand: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'],
        longhand: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월']
      }
    },
    onChange(selectedDates) {
      if (selectedDates.length === 2) {
        dateFrom = selectedDates[0];
        dateTo   = selectedDates[1];
        dateTo.setHours(23, 59, 59, 999);
      } else {
        dateFrom = dateTo = null;
      }
      applyFilter();
    }
  });

  dateClearBtn.addEventListener('click', function() {
    fp.clear();
    dateFrom = dateTo = null;
    applyFilter();
  });

  // ── 태그 필터 ─────────────────────────────────────────────────────────────
  allTagBtn.addEventListener('click', function() {
    selectedTags.clear();
    filterBtns.forEach(b => b.classList.remove('active'));
    applyFilter();
  });

  filterBtns.forEach(btn => {
    if (btn.dataset.tag === 'all') return;
    btn.addEventListener('click', function() {
      const tag = this.dataset.tag;
      if (selectedTags.has(tag)) { selectedTags.delete(tag); this.classList.remove('active'); }
      else                       { selectedTags.add(tag);    this.classList.add('active');    }
      applyFilter();
    });
  });

  // ── 검색 ──────────────────────────────────────────────────────────────────
  let searchTimeout = null;
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchQuery = this.value.toLowerCase().trim();
        applyFilter();
      }, 200); // 200ms 디바운스
    });
  }

  // ── URL 파라미터로 카테고리 선택 ─────────────────────────────────────────
  function initFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const catParam = params.get('cat');
    if (catParam) {
      selectedCatPath = catParam;
    }
  }

  // ── 초기화 ────────────────────────────────────────────────────────────────
  initFromUrl();
  buildSidebar();

  // URL 파라미터로 선택된 카테고리가 있으면 해당 버튼 활성화
  if (selectedCatPath) {
    sidebar.querySelectorAll('.category-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.cat === selectedCatPath) {
        btn.classList.add('active');
        // 상위 그룹들 expand
        let group = btn.closest('.cat-group');
        while (group) {
          group.classList.add('expanded');
          group = group.parentElement.closest('.cat-group');
        }
      }
    });
  }

  applyFilter();
});
</script>
