---
title: 카드계 개발 젠킨스 문제(~202312현재)/java 클래스의 롤링배포 방식 문제
date: 2024-02-07
tags:
  - Java
  - BXM
  - CI/CD
  - 케이뱅크
category: 실무경험
---


### ASIS

카드 개발서버 젠킨스는 현재 소스 “파일 내용”의 “변동분”을 컴파일 하는 중이다
SVN에서 커밋된 자바 소스의 변동분만 01_crd_pre_build 단계에서 선별한 후 다음 파이프라인으로 보낸다
그러므로 소스 단계에서 바뀌지 않은 부분은 재컴파일되지 않는다.

그러면 생기는 문제점
바뀌지 않은 소스가 문제를 일으킬 수 있음
  - 예를들면
    1. Omm 파일의 멤버 타입만 바꾸는 경우
    2. Omm파일은 정상 수정했지만 Omm이 만든 java 파일이 SVN에서 충돌이 나고 해당 Omm객체를 사용하는 서비스 코드는 잘 반영된 경우(카드계 개발서버 흔히 젠킨스 빨간불 뜨는 경우)

왜?

```java
public class SomeService {
	public void someMethod() {
		SomeDTO dto = new someDTO();
		dto.getValue(); //대충 이런 로직이라 치고
	}
}
```

예시 코드
아래는 bxm omm 파일 예시

```java
OMM ~~~.SomeDTO
<description="~~~">
{
	String someValue<length=10 description="~~~">
}
```

아래는 bxm omm 의 src-gen 하위의 소스(omm 수정 시 자동 생성)

```java
public class SomeDTO { //이건 BXM omm이라 가정해
	private String value;
//getter setter
}
```


만약 omm 소스의 value 타입을 Integer로 바꾸었다 치면,
  - bxm 이클립스가 SomeDTO.omm 변동분을 보고 SomeDTO.java를 다시 생성할 것
    - 그리고 Build Workspace를 하면서(상당히 느리게) SomeDTO를 물고있는 소스들을 재컴파일 함
하지만 이 상태로 SVN Commit을 하는 경우, NoSuchMethodException이 발생
왜냐하면 SomeService.java는 변동분이 없음(소스를 바꾸지 않았으므로)
  - 그러므로 SomeService.class도 재생성되지 않음

SomeService.class의 바이트코드를 뜯어보면 String getValue() 이런식으로 메서드의 리턴타입까지 포함된 signature를 참조해서 호출하려 함.

```java
// 메소드 선언
.method public printMessage(Ljava/lang/String;)V

    // 메소드 시작
    .limit stack 2
    .limit locals 2

    // 메소드 코드
    getstatic java/lang/System/out Ljava/io/PrintStream;
    aload_1
    invokevirtual java/io/PrintStream/println(Ljava/lang/String;)V

    // 메소드 종료
    return
.end method
```

대충 이런식으로 나옴 (예시는 System.out.println을 호출하는 경우)

하지만 SomeDTO 에는 이제 더 이상 String 타입의 getValue는 더이상 존재하지 않음. 왜냐하면 SomeDTO의 someValue는 이제 Integer이므로 bxm에서 getter setter 자동 재생성했음.

그러므로 [SomeService.java](http://SomeService.java) 파일의 내용을 바꿔서 젠킨스가 다시 컴파일 돌리도록 유도해야함.
실제로 [SomeService.java](http://SomeService.java) 같은 케이스는 코드 실행 순서만 좀 바꾸는 경우 바로 문제없어진다.

이러한 문제는 형상관리시스템에서 스테이징 배포하는 경우 발생하지 않는다. 젠킨스에서만 항상 충돌 남
  - 왜냐하면 젠킨스는 버튼을 누르면 변동된 소스 파일을 발라내서 재컴파일 하는것이고
  - 형상에서 배포버튼은 배포 대상 소스를 “체크” 하고 “배포”버튼을 눌러서 재컴파일 하는 것이기 때문에 변동이고 뭐고 다시 선택한 소스를 복사/컴파일/배포 한다(여기는 추측임)
  **검증결과**
    - 이게 맞았음. 최근에 다른 분이 개발 스테이징에서는 잘되는데 운영에서 안됐다고 해서 들어보니 딱 이 케이스여서 형상목록을 봤는데 이번에는 dto의 get set을 사용하는 Business java 로직은 건들지 않고 dto 파일만 체크인해서 형상배포 했던 것. 
    - 2주뒤 배포되는 문서에 business 로직을 넣어놓고 오늘 배포되는 문서에 dto를 넣어놓고 스테이징 체크인/롤링배포를 할 때는 두 형상문서 다 배포를 자유롭게 누를 수 있으니 둘 다 체크인하고 배포했으니 문제를 못느꼈는데(또는 어? 안되네 하고 갖고있는 형상을 모두 스테이징 재배포 했을 확률도 있음) 운영에 갈 때는 dto 가 들어있는 문서만 배포를 했으니 당연히 문제가 생긴다고 설명해드림.
    - 후에 다른분들에게도 전파 완료.

하지만 카드 개발서버 젠킨스에는 선택한 소스를 클린 컴파일 배포 하는 버튼이 없으므로 이런 문제가 생기는 것 같음(추측)
5분마다 도는 잡인데 CRDBat/CRDAp 안의 모든 소스들을 5분마다 재컴파일 하는 작업은 쉽지 않으므로 파이프라인에 클린을 추가하기보다는 
Clean build를 하는 새로운 파이프라인(수동으로 실행가능한)을 추가하는것이 필요함.
  - 영향도 분석 솔루션이 이런것 분석 해주는 기능도 있을법한데 없음…
