---
title: "주식 단위업무 MSA Arch 개선"
date: 2024-05-28
tags: [미지정]
category:
  - 재테크
---
상장주식 영역이 추가됨에 따라 기존 Gitlab Repository 구조 개선 건의

### ASIS in Kbank ITSquare

각각 프로젝트마다 CHA 문서 한 건씩 해서 프로젝트 하나 만들 때 마다 N건의 프로젝트 - N건의 파이프라인 - N건의 배포를 해야 함.
단순히 프로젝트 N건이면 그냥 IDE에서 프로젝트 설정으로 끝내겠는데 문서까지 N개를 만들어야 하고 테스트케이스(를 위한 문서)도 N개를 만들어야 함
그리고 업무로직은 공통으로 가져가지만 각각의 배포와 업무는 다를 수 있는 업무 들이 있음


![](/assets/images/Pasted%20image%2020260228171245_544e3101.jpg)


사유:
ASIS - 위에 붙어있는 Argo 마크가 다 Gitlab Repository로 분리되어 있었음.
  - 그렇게 되다보니 같은 DB에 있고 유사한 업무구조인데 프로젝트를 분리하는게 맞나라는 생각.
    - ex) ipo-service에서 DB 관련된 공통 모듈, 설정을 만들어놓으면 현재는 ipo-data-load-job을 만들 때 만들어놓은 모듈을 복붙해감. + 새로운 pod가 만들어 질 때마다 반복
  - 그리고 하나의 업무 변경을 하려다 보면 CHA branch를 5개씩 만들어서 각각 커밋하고 배포해야 하는 구조가 비효율적이라는 판단


1안
  - 장점 - 중복리소스 최소화
  - 단점 
    - 영향도 파악 리스크
      - 현재Branch 전략에 물려있는 Argo CD 프로젝트는 push hook가 오면 그냥 빌드 하는 구조라서 docker push를 일괄 수행해버림
      - 일부 서비스만 변경했는데 STK 하위 모든 파드가 재배포될 수 있음
      - 하위 디렉터리 변경건이 있는 경우에만 docker build 하는 스크립트 추가 해야할듯

2안
  - 장점 - 각 단위업무간 영향도 없음
  - 단점 
    - 중복 소스 문제를 100% 해결하지 못함
      - 만약에 다른 단위업무의 기능을 사용하기 위해서는 서비스 소스 복붙 또는 파드간 통신으로 해결해야 함


### SRE 회의 후 결론

현재 SRE가 제시하고 있는 Argo CD 기준으로는 1 project 1 service이므로 온디맨드 서비스 하나에 프로젝트 하나. 배치의 경우 공통 프로젝트 하나 만들고 개별 배포 가능하도록.
일단 공통모듈에 대한 바운더리가 너무 커버리면 짬통이 되어 모놀리틱이 될 수 있다는 개인적인 우려
  - 그래서 계정계는 하려고 하다가 안하기로 했다고 함


### 1 : N 구조 불가 한 이유

IT스퀘어에서 해당 기능을 제공하지 않음
  - SVN + 형상관리 기반으로 되어있는 개발자포털이므로 gitlab branch 전략이 엉성하게 구성되어 있음.
  - 특정 project의 branch에 대해 접근, 빌드된 이미지 중 특정 이미지만 배포하게 할 수 있는 구조가 현재 아니므로 만약 현재 IT스퀘어 기준으로 배포를 수행한다면 프로젝트에 물려있는 gradle image는 싹다 배포되어 올라갈 것. 
  - 하지만 현재 IT스퀘어를 사용하지 않고 Gitlab + Argo CD 만으로 배포할 수는 없음(정책문제)
  - …


서브모듈을 사용해서 소스간의 일관성은 일단 임시로 유지시켜놓은 상태.

하지만 프로젝트가 많아진다는것은 IT스퀘어를 사용하고 있는 케이뱅크에서는 개발생산성에 치명적인 악영향을 주기 때문에 어플리케이션과 argo-workflow.yaml 파일의 배포 구조 개선이 필요할 것 같음.
