---
title: "공모주 메이트 2차 리팩토링"
date: 2026-02-12
tags: [미지정]
category:
  - 재테크
---





### 쿼리 리팩토링



```sql
				SELECT   
                a.baseDt /*기준일자*/
            , a.itmsCdNbr /*종목코드번호*/
            , CASE WHEN a.dmdFrcsStartYn = '3' THEN 'Y' ELSE 'N' END AS dmdFrcsStartYn /*수요예측시작여부*/
            , CASE WHEN a.sbscStartYn = '1' THEN 'Y' ELSE 'N' END AS sbscStartYn /*청약시작여부*/
            , CASE WHEN a.stckLstnYn = '2' THEN 'Y' ELSE 'N' END AS stckLstnYn /*주식상장여부*/
            , a.intnlScrtsDstgNbr /*국제증권식별번호*/
            , a.stckKorNm /*주식한글명*/
            , a.stckMrktDsCd /*주식시장구분코드*/
            , a.inpStsVal /*입력상태값*/
            , a.inpStsChngDt /*입력상태변경일자*/
            , a.dmdFrcsStartDt /*수요예측시작일자*/
            , a.dmdFrcsEndDt /*수요예측종료일자*/
            , a.sbscStartDt /*청약시작일자*/
            , a.sbscClsgDt /*청약마감일자*/
            , a.pymDt /*납입일자*/
            , a.drbcDt /*환불일자*/
            , a.stckLstnDt /*주식상장일자*/
            , a.lwenScdlPbofAmt /*하단예정공모금액*/
            , a.tppoScdlPbofAmt /*상단예정공모금액*/
            , a.cnfmPbofAmt /*확정공모금액*/
            , a.pbofStckCnt /*공모주식건수*/
            , a.sbscRvlrRt /*청약경쟁율*/
            , a.rprsSpicComNm /*대표주관회사명*/
            , a.jointSpicComNm /*공동주관회사명*/
            , a.rbpeComNm /*인수회사명*/
            , a.fssRcipNbr /*금감원접수번호*/
            , a.stckFaceAmt /*주식액면금액*/
            , a.aissGnrlStckCnt /*기발행일반주식건수*/
            , a.aissPrtyStckCnt /*기발행우선주식건수*/
            , a.nmnRrtProxyInstNm /*명의개서대행기관명*/
            , a.dmdFrcsRvlrRt /*수요예측경쟁율*/
            , a.oblgDfpnAplctRate /*의무확약신청비율*/
            , a.sbscMaxDt /*청약최대일자*/
        FROM ( SELECT  row_number() over() as rownum, a.* 
                FROM (
                        /* #### Original SQL [[ ################# */
                        SELECT  A.baseDt /*기준일자*/
                            , A.ITMS_CD_NBR           AS itmsCdNbr /*종목코드번호*/
                            , A.dmdFrcsStartYn        AS dmdFrcsStartYn /*수요예측시작여부*/
                            , A.sbscStartYn           AS sbscStartYn /*청약시작여부*/
                            , A.stckLstnYn            AS stckLstnYn /*주식상장여부*/
                            , A.INTNL_SCRTS_DSTG_NBR  AS intnlScrtsDstgNbr /*국제증권식별번호*/
                            , A.STCK_KOR_NM           AS stckKorNm /*주식한글명*/
                            , A.STCK_MRKT_DS_CD       AS stckMrktDsCd /*주식시장구분코드*/
                            , A.INP_STS_VAL           AS inpStsVal /*입력상태값*/
                            , A.INP_STS_CHNG_DT       AS inpStsChngDt /*입력상태변경일자*/
                            , A.DMD_FRCS_START_DT     AS dmdFrcsStartDt /*수요예측시작일자*/
                            , A.DMD_FRCS_END_DT       AS dmdFrcsEndDt /*수요예측종료일자*/
                            , A.SBSC_START_DT         AS sbscStartDt /*청약시작일자*/
                            , A.SBSC_CLSG_DT          AS sbscClsgDt /*청약마감일자*/
                            , A.PYM_DT                AS pymDt /*납입일자*/
                            , A.DRBC_DT               AS drbcDt /*환불일자*/
                            , A.STCK_LSTN_DT          AS stckLstnDt /*주식상장일자*/
                            , A.LWEN_SCDL_PBOF_AMT    AS lwenScdlPbofAmt /*하단예정공모금액*/
                            , A.TPPO_SCDL_PBOF_AMT    AS tppoScdlPbofAmt /*상단예정공모금액*/
                            , A.CNFM_PBOF_AMT         AS cnfmPbofAmt /*확정공모금액*/
                            , A.PBOF_STCK_CNT         AS pbofStckCnt /*공모주식건수*/
                            , A.SBSC_RVLR_RT          AS sbscRvlrRt /*청약경쟁율*/
                            , A.RPRS_SPIC_COM_NM      AS rprsSpicComNm /*대표주관회사명*/
                            , A.JOINT_SPIC_COM_NM     AS jointSpicComNm /*공동주관회사명*/
                            , A.RBPE_COM_NM           AS rbpeComNm /*인수회사명*/
                            , A.FSS_RCIP_NBR          AS fssRcipNbr /*금감원접수번호*/
                            , A.STCK_FACE_AMT         AS stckFaceAmt /*주식액면금액*/
                            , A.AISS_GNRL_STCK_CNT    AS aissGnrlStckCnt /*기발행일반주식건수*/
                            , A.AISS_PRTY_STCK_CNT    AS aissPrtyStckCnt /*기발행우선주식건수*/
                            , A.NMN_RRT_PROXY_INST_NM AS nmnRrtProxyInstNm /*명의개서대행기관명*/
                            , A.DMD_FRCS_RVLR_RT      AS dmdFrcsRvlrRt /*수요예측경쟁율*/
                            , A.OBLG_DFPN_APLCT_RATE  AS oblgDfpnAplctRate /*의무확약신청비율*/
                            ,(SELECT MAX(SCA.MAX_DT) 
                                FROM (SELECT  MAX(DMD_FRCS_START_DT) AS MAX_DT
                                        FROM  TB_STK_PBOF_SBSC_INFO_X 
                                        WHERE  DMD_FRCS_START_DT > TO_CHAR(NOW(),'YYYYMMDD')
                                        AND  INP_STS_VAL  <> 'D'
                                        UNION  ALL
                                        SELECT  MAX(SBSC_START_DT)  AS MAX_DT
                                        FROM  TB_STK_PBOF_SBSC_INFO_X 
                                        WHERE  SBSC_START_DT > TO_CHAR(NOW(),'YYYYMMDD')
                                        AND  INP_STS_VAL  <> 'D'
                                        UNION  ALL
                                        SELECT  MAX(STCK_LSTN_DT)  AS MAX_DT
                                        FROM  TB_STK_PBOF_SBSC_INFO_X 
                                        WHERE  STCK_LSTN_DT > TO_CHAR(NOW(),'YYYYMMDD')
                                        AND  INP_STS_VAL <> 'D' ) SCA) AS sbscMaxDt
                        FROM (SELECT  A.BASE_DT AS baseDt
                                    ,(CASE WHEN A.BASE_DT = B.DMD_FRCS_START_DT THEN '3'
                                            ELSE 'N'
                                            END ) AS dmdFrcsStartYn
                                    , 'N'     AS sbscStartYn
                                    , 'N'     AS stckLstnYn
                                    , B.*
                                FROM (SELECT  TO_CHAR(A.DATE, 'YYYYMMDD') AS BASE_DT
                                        FROM (( WITH date_series AS (
                                                SELECT DATE(GENERATE_SERIES(TO_DATE(#{inqStartDt}, 'YYYYMMDD'),TO_DATE(#{inqEndDt}, 'YYYYMMDD'), '1 days')))
                                                SELECT  DATE 
                                                FROM  date_series )) A) A
                                    , TB_STK_PBOF_SBSC_INFO_X B
                                WHERE  A.BASE_DT = B.DMD_FRCS_START_DT
                                UNION ALL
                                SELECT  A.BASE_DT AS baseDt
                                    , 'N'   AS dmdFrcsStartYn
                                    ,(CASE WHEN A.BASE_DT = B.SBSC_START_DT THEN '1'
                                            ELSE 'N'
                                            END ) AS sbscStartYn
                                    , 'N'     AS stckLstnYn
                                    , B.*
                                FROM (SELECT  TO_CHAR(A.DATE, 'YYYYMMDD') AS BASE_DT
                                        FROM (( WITH date_series AS (
                                                SELECT DATE(GENERATE_SERIES(TO_DATE(#{inqStartDt}, 'YYYYMMDD'),TO_DATE(#{inqEndDt}, 'YYYYMMDD'), '1 days')))
                                                SELECT  DATE 
                                                FROM  date_series )) A) A
                                    , TB_STK_PBOF_SBSC_INFO_X B
                                WHERE  A.BASE_DT = B.SBSC_START_DT
                                UNION ALL
                                SELECT  A.BASE_DT AS baseDt
                                    , 'N'     AS dmdFrcsStartYn
                                    , 'N'     AS sbscStartYn
                                    ,( CASE WHEN A.BASE_DT = B.STCK_LSTN_DT THEN '2'
                                            ELSE 'N'
                                            END ) AS stckLstnYn
                                    , B.*
                                FROM (SELECT  TO_CHAR(A.DATE, 'YYYYMMDD') AS BASE_DT
                                        FROM (( WITH date_series AS (
                                                SELECT DATE(GENERATE_SERIES(TO_DATE(#{inqStartDt}, 'YYYYMMDD'),TO_DATE(#{inqEndDt}, 'YYYYMMDD'), '1 days')))
                                                SELECT  DATE 
                                                FROM  date_series )) A) A
                                    , TB_STK_PBOF_SBSC_INFO_X B
                                WHERE  A.BASE_DT = B.STCK_LSTN_DT ) A
                        ORDER BY baseDt ASC, sbscStartYn ASC, stckLstnYn ASC, dmdFrcsStartYn ASC, dmdFrcsRvlrRt DESC, stckKorNm ASC, itmsCdNbr ASC
                        /* #### Original SQL ]] ################# */) a
            WHERE (
                (
                baseDt = #{baseDtNextKey}
                AND sbscStartYn =
                    CASE WHEN #{sbscStartYnNextKey} = 'Y' THEN '1'
                    WHEN #{sbscStartYnNextKey} = 'N' THEN 'N' ELSE '' END
                AND stckLstnYn =
                    CASE WHEN #{stckLstnYnNextKey} = 'Y' THEN '2'
                    WHEN #{stckLstnYnNextKey} = 'N' THEN 'N' ELSE '' END
                AND dmdFrcsStartYn =
                    CASE WHEN #{dmdFrcsStartYnNextKey} = 'Y' THEN '3'
                    WHEN #{dmdFrcsStartYnNextKey} = 'N' THEN 'N' ELSE '' END
                AND dmdFrcsRvlrRt = #{dmdFrcsRvlrRtNextKey}
                AND stckKorNm > #{stckKorNmNextKey}
                )
                OR (
                    baseDt = #{baseDtNextKey}
                    AND sbscStartYn =
                        CASE WHEN #{sbscStartYnNextKey} = 'Y' THEN '1'
                        WHEN #{sbscStartYnNextKey} = 'N' THEN 'N' ELSE '' END
                    AND stckLstnYn =
                        CASE WHEN #{stckLstnYnNextKey} = 'Y' THEN '2'
                        WHEN #{stckLstnYnNextKey} = 'N' THEN 'N' ELSE '' END
                    AND dmdFrcsStartYn =
                        CASE WHEN #{dmdFrcsStartYnNextKey} = 'Y' THEN '3'
                        WHEN #{dmdFrcsStartYnNextKey} = 'N' THEN 'N' ELSE '' END
                    AND dmdFrcsRvlrRt < #{dmdFrcsRvlrRtNextKey}
                )
                OR (
                    baseDt = #{baseDtNextKey}
                    AND sbscStartYn =
                        CASE WHEN #{sbscStartYnNextKey} = 'Y' THEN '1'
                        WHEN #{sbscStartYnNextKey} = 'N' THEN 'N' ELSE '' END
                    AND stckLstnYn = CASE
                        WHEN #{stckLstnYnNextKey} = 'Y' THEN '2'
                        WHEN #{stckLstnYnNextKey} = 'N' THEN 'N' ELSE '' END
                    AND dmdFrcsStartYn > CASE
                        WHEN #{dmdFrcsStartYnNextKey} = 'Y' THEN '3'
                        WHEN #{dmdFrcsStartYnNextKey} = 'N' THEN 'N' ELSE '' END
                )
                OR (
                    baseDt = #{baseDtNextKey}
                    AND sbscStartYn = CASE
                        WHEN #{sbscStartYnNextKey} = 'Y' THEN '1'
                        WHEN #{sbscStartYnNextKey} = 'N' THEN 'N' ELSE '' END
                    AND stckLstnYn > CASE
                        WHEN #{stckLstnYnNextKey} = 'Y' THEN '2'
                        WHEN #{stckLstnYnNextKey} = 'N' THEN 'N' ELSE '' END
                )
                OR ( baseDt = #{baseDtNextKey}
                    AND sbscStartYn > CASE
                        WHEN #{sbscStartYnNextKey} = 'Y' THEN '1'
                        WHEN #{sbscStartYnNextKey} = 'N' THEN 'N' ELSE '' END
                )
                OR ( baseDt > #{baseDtNextKey} )
                )
            ) a
        WHERE a.rownum <= (#{pageCount} + 1) 
```


요약: 프론트에서 뿌려줘야 할 내용을 SQL로 한 방에 준다

크게 세 파트로 나뉘는 것 같음
1. 단순 데이터 조회 부분(엔티티의 고유 값)
2. 각 일자마다 해당하는 종목
  - 그러니깐 inqStartDt ~ inqEndDt 사이에 
  1. 수요예측시작일인 종목
  2. 청약시작일인 종목
  3. 상장일인 종목
  - 을 중복해서 리스트로 줘야한다 이런식으로

```sql
{
            "baseDate": "20260220",
            "itemCodeNumber": "279570",
            "bookbuildingStarted": "N",
            "subscriptionStarted": "Y",
            "listed": "N",
            "isin": "KR7279570006",
            "stockKoreanName": "케이뱅크",
            "stockMarketCode": "1",
            "status": "U",
            "lastChangedAt": "20260203",
            "bookbuildingStartDate": "20260204",
            "bookbuildingEndDate": "20260210",
            "subscriptionStartDate": "20260220",
            "subscriptionEndDate": "20260223",
            "paymentDate": "20260225",
            "refundDate": "20260225",
            "listedDate": "20260305",
            "bottomOfThePriceRange": "8300.00",
            "topOfThePriceRange": "9500.00",
            "finalOfferingPrice": "0.00",
            "sharesOutstanding": "60000000.00",
            "oversubscriptionRate": "0.00",
            "leadUnderwriter": "NH투자,삼성증권",
            "jointBookrunner": "",
            "underwritingSyndicateMembers": "신한투자증권",
            "dartReportNumber": "20260129000644",
            "parValue": "5000.00",
            "commonSharesListed": "375695151",
            "preferredSharesListed": "0",
            "transferAgentName": "한국예탁결제원",
            "bookbuildingSubscriptionRatio": "0.00",
            "lockupRate": "0.00",
            "subscriptionMaxDate": "20260317"
        }
```

3. 달력 조회 시 스캔 범위의 끝
  - "subscriptionMaxDate": "20260317" 이렇게 줌
  - 위 쿼리에서 스칼라 값으로 모든 로우에 들어가있음

```sql
SELECT  MAX(DMD_FRCS_START_DT) AS MAX_DT
FROM  TB_STK_PBOF_SBSC_INFO_X
WHERE  DMD_FRCS_START_DT > TO_CHAR(NOW(),'YYYYMMDD')
AND  INP_STS_VAL  <> 'D'
UNION  ALL
SELECT  MAX(SBSC_START_DT)  AS MAX_DT
FROM  TB_STK_PBOF_SBSC_INFO_X
WHERE  SBSC_START_DT > TO_CHAR(NOW(),'YYYYMMDD')
AND  INP_STS_VAL  <> 'D'
UNION  ALL
SELECT  MAX(STCK_LSTN_DT)  AS MAX_DT
FROM  TB_STK_PBOF_SBSC_INFO_X
WHERE  STCK_LSTN_DT > TO_CHAR(NOW(),'YYYYMMDD')
AND  INP_STS_VAL <> 'D'
```


그러므로 나는 특정 기간동안 어떤 이벤트(수요예측시작일,청약시작일,상장일) 에 해당하는 종목들을 리스트로 N번 BFF에서 찔러서 조합해서 해당 전문을 내보내는 식으로 쿼리를 풀 예정이고
3번 스칼라 값은 조회조건이 변해도 변하지 않기 때문에 별도의 캐시로 적재할 예정


### V2 api 명세


기존에 있던 api로 2번은 대체 가능할 것 같고
- /ipo-service/offering-schedules/{ipoStatus}/latest
  - 진짜 마음에 들지 않지만 이것도 하나 만들어
