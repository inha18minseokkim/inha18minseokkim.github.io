---
title: "Kafka with Kbank MSA + 표준 스케줄러"
date: 2024-07-11
tags:
  - Kafka
  - KEDA
  - 인프라
category:
  - 기술
---
Kafka와 KEDA를 활용한 인프라 구성 정리.
[[Kubernetes] Keda 란?](https://velog.io/@jihwankim94/Kubernetes-Keda-란)

## ASIS 문제점

케이뱅크 내부에서 배치 프로그램을 실행하려고 하는 경우 Control M이라고 하는 관제 시스템을 사용하여 수행을 해야 함(JFlow)
  - 그래서 MSA 환경에 있는 pod도 JFlow에 요청 →IDC에 있는 CTM 이 스크립트를 실행하여 EKS에 있는 Argo Workflow에 트리거 보냄 → Argo Workflow가 work node에 이미지 넣고 돌림 → 스프링 배치 실행
  - 이렇게 하지 않으면 집에서 관제가 불가능

## Pub에 관하여

Message를 Pub 하여 트리거를 생성하는 경우는 크게 두 가지 케이스로 고려함
1. 데몬 형식 pod가 떠있으면서 기동함
  - kafka streams, spring boot @Scheduled, Quartz 등등..
2. job 형식의 pod를 실행하여 message pub
  - spring batch, 그냥 spring application, 그냥 java application
    - 다만 현재는 배치가 아니라 그냥 돌고 끝나는 간결한 스크립트 형식으로 끝나는 프로그램은 관련 가이드라인이 정해져있지 않아.. 쓸 수 없음.

### 데몬 형식을 케이뱅크에서 쓸 수 없는 이유(202407 현재)

1. 관제 불가
  - 데몬형식으로 사용한다면 스케줄러 같은 기능으로 기동을 할 텐데, 떠있는동안 락이 걸린다면.. 만약 그게 퇴근 후 시간이라면 관제가 불가능. 
    - 물~~론 이런 일이 생길 일은 없지만 그날이 왔을 때 대처가 안되기 때문에 빠져나갈 구멍은 생각해놓는 느낌
  - 현재 원격지에서 특정 기능을 수행하게 하려면 JFlow를 통해서 해야 함. 그리고 pod를 삭제하는 등의 동작은 현재 불가능함
    - JFlow에서 Kubectl delete pod ~~ 같은 것을 날릴 수 있는 기능을 개발하면 가능할것 같기도 함. 다만 깔끔한 방법은 아닌듯함. 
2. 영업일 판단 불가(202407 현재 MSA 환경에서는 불가)
  - 현재 사용하려면 cronjob, spring scheduler, Quartz 같은 스케줄러를 사용하면 주말 정도는 판단이 가능하겠지만 추석, 설, 대통령이 지정한 한시적인 공휴일 등..은 판별 불가.
  - 해당 기능은 계정계 공통(뱅플팀) 에서 영업일 테이블을 유지중인데, 현재 계정계 IDC 오라클 db를 여기서 바라볼 수 없음. 
  - ETL 툴로 해당 DB 대사를 하더라도 CSV>STK DB에 해당 테이블을 넣는것도 이상. 
    - 단위 업무마다 db가 논리적으로 분리되어있는 상황인데, 주식 단위업무, 환율, 유가, 지수, 퀴즈 등 각각의 단위업무에 테이블을 모두 복제하는것보다 계정계공통이라는 공통 Namespace를 만들어 해당 기능을 api로 제공하는것이 관리포인트도 하나고 깔끔하다는 생각이 들었음
      - 문제는 계정계 공통이 아직 넘어온 것이 없다는 것.

그러므로… 어쩔 수 없이 트리거를 날릴 수 있고 관제가 가능한 JFlow에서 배치 어플리케이션을 사용하기로 함.
+) 여기서 Pub이란 외부 오픈API 데이터 수신을 위해 사용하는 Kafka에 대한 Pub임. 


## Sub에 관하여

Pub을 하고 api 솔루션이 해당 메세지를 sub 후 대외에 Rest Call 한 응답값을 토픽에 pub ⇒ 해당 토픽을 MSA 클러스터 내부에서 Sub 하는 방식

크게 두 가지 해법이 있다는 생각
1. Spring batch KafkaItemReader 사용
2. Spring kafka 또는 Apache Kafka의 Consumer를 서버형식으로 띄워놓고 event listening

batch 형식의 문제점
1. 언제 batch pod을 기동?
  - ⇒ 35분에 pub 하고 37분에 sub을 기동하는건 하고싶지 않음. CTM은 topic listening을 지원하지 않음
  - ⇒ Argo Workflow에서 토픽에 새로운 메세지 pub을 인식하면 해당 파드를 띄우는방식이 가능하면 될듯??

일단 잠정적인 결론 : daemon을 띄워놓고 eventListener로 사용하기로 함
우려되는 문제
1. 관제가 불가능 : pub에서 다룬 문제처럼 관제가 불가능할 수 있다.
  - ⇒ 이건 비즈니스 로직에서 해결하는것이 맞다고 생각을 함. 어차피 배치 파드 기동방식으로 해도 프로그램을 멱등성있게 짰다면 다시 시도해도 똑같을것이라는 가정.
    - 배치 역시 해결할 수 있는 문제가 아니므로 얘는 관제의 영역에서 애초에 해결이 안되니 생각하지말자!! ⇒ 결론
2. 리소스 낭비
  - 물론 개발자가 고민할 문제까진 아닌것같지만.. 하루에 한번 도는 파드를 계속 메모리 할당해놓기도..
  - ⇒ KEDA를 사용해서 클러스터가 kafka를 찌르면서 특정 토픽이 pub 되는 경우 해당 파드 HPA 하는 방식이 가능하다고 하심

일단 다음과 같은 해결책(+변명과 합리화) 이 완성되었으므로 sub은 daemon 형식으로 간다

