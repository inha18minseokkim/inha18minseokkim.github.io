---
title: "코드성 vs Enum vs 도메인 분리"
date: 2024-02-15
tags: [미지정]
category:
  - 기타
---

## ASIS

행 내에 식품물가는 현재 Kamis 지역정보, Kbank 지역정보, Push메세지,Push제목,Push URL 이 정보들이 한 테이블에 코드로 짬통으로 들어가있음
마이그레이션 작업을 하면서 기존 업무와 크게 차이나지 않도록 설계하려고 하는데 객체와 객체간의 관계로 표현하기 쉽지 않음
예를 들어,

```java
public class UserCode {
    @Id
    private String id;
    private String codeDetailName;
    private String description;
    private Long orderSequence;
    private Boolean useInfo;
    @ManyToOne
    @JoinColumn(foreignKey = @ForeignKey(ConstraintMode.NO_CONSTRAINT))
    private UserGroupCode userGroupCode;
}
```

이런 엔티티에 codeDetailName에 지역코드가 들어감(서울 1101)
지역에 관한 내용이 없음

```java
// 1년치 가격 뽑아옴
List<FindPriceListByGroupRegionCodeOut> priceList
        = processedPriceInfoReader.findPriceListByGroupRegionCode
        (FindPriceListByGroupRegionCodeInDto.builder()
                .regionGroupCodeId(criteria.getRegionGroupId())
                .baseDate(latestBaseDate)
                .rangeForLength(BaseRange.YEAR)
                .rangeForTag(BaseRange.DAY)
                .targetInnerProductId(criteria.getInnerProductId()).build());
```

regionGroupCodeId 이런식으로 억지로 표현함

```java
return results.stream().map((element) -> FindPriceListByGroupRegionCodeOut.builder()
                .baseDate(in.getBaseDate())
                .price(element.get(processedPriceInfo.price.avg()).longValue())
                .regionGroupCodeId(element.get(userGroupCode).getId())
                .innerProductId(element.get(innerProduct).getId())
                .baseRange(in.getRangeForLength())
                .build()
        ).collect(Collectors.toList());
```

하지만 결국 Reader에서 userGroupCode → regionGroupCodeId 로 어거지 이름을 매핑해줘야함. 
마이그레이션 할 때 제대로 정리하고 가야 나중에 잘 알아먹을 수 있음

TOBE 대안을 생각해보면
1. 지역코드를 Enum으로 전환
2. 지역코드 테이블 및 엔티티를 새로 만든다
3. UserGroupCode, UserCode를 사용하되 상속해서 사용한다
4. 그냥 쓴다


### 지역코드를 Enum으로 전환

[https://techblog.woowahan.com/2527/](https://techblog.woowahan.com/2527/)
[https://www.inflearn.com/questions/29286/공통-코드-테이블을-운영-할-경우-엔티티-설계를-어떻게-하는게-좋을까요](https://www.inflearn.com/questions/29286/%EA%B3%B5%ED%86%B5-%EC%BD%94%EB%93%9C-%ED%85%8C%EC%9D%B4%EB%B8%94%EC%9D%84-%EC%9A%B4%EC%98%81-%ED%95%A0-%EA%B2%BD%EC%9A%B0-%EC%97%94%ED%8B%B0%ED%8B%B0-%EC%84%A4%EA%B3%84%EB%A5%BC-%EC%96%B4%EB%96%BB%EA%B2%8C-%ED%95%98%EB%8A%94%EA%B2%8C-%EC%A2%8B%EC%9D%84%EA%B9%8C%EC%9A%94)
객체-객체 관계에서 가장 큰 걸림돌이 되는것이 기존에 사용하던 공통 테이블에 때려넣고 여러 도메인에서 해당 코드를 참조해서 작업하는 경우

1. 사실 지역코드가 바뀔일이 잘 없다
  - 아니 6개월동안 몇 번 바뀌기는 했는데 Kamis쪽에서 차세대? 한다고 좀 많이 바꿔서 그랬고 이제는 안바뀔 것 같음
2. 다만 케이뱅크는 2024년 2월 현재 배포 주기가 1주일이다(매일 화요일 오후 8시)
  - EKS에서 Argo CD, Pod 6개 Api GateWay 모두 MSA로 되어있어 순차 배포하기 때문에 99% 영향이 없지만 행 내 배포 정책 상 MSA 환경 배포도 오후 8시에 하라고 한다(….)
    - 그러므로 지역코드가 바뀌면 다음주 반영이라 그동안 계속 에러 남 + 화요일 오후 8시에 남아서 있어야함(아무것도 안하고)
1번 이유로 고민했지만 2번 이유로 인해 못할 것 같다


### 지역코드 테이블 및 엔티티를 새로 만든다

UserGroupCode,UserCode를 RegionGroup, Region으로 이름 바꾸고 컬럼도 이름 바꾼다. 
그 외에 푸시 테이블용 엔티티를 따로 만듬. 푸시 메세지,제목,URL의 경우 딱히 객체와 연관관계 없어도 되므로 그냥 만든다(배치에서 하루에 한 번 일회성으로 긁어와서 활용하므로 굳이 연관관계에 넣어서 복잡하게 만들 필요 없음)
  - 푸시 배치는 객체 관계 필요없이 푸시 내용 긁어 → 대상 고객 긁어 → EAI 대상 테이블 적재가 끝이기 때문에 Mybatis 쿼리로 끝내버리려 함

### UserGroupCode,UserCode를 사용하되 상속해서 사용

RegionGroup,Region 엔티티와 내부 필드를 새로 만들지만 각각 UserGroupCode와 UserCode를 상속하게 하여 어거지로 맞추는 느낌으로 사용
안에 있는 필드 이름도 다르게 매핑해서 사용
변경사항이 있는 경우 그냥 관리자화면에서 UserGroupCode,UserCode를 정정하는식으로
이렇게하면 조회조건 잘못 주는 경우 다른 서비스에서 영향받는 문제생길수도있겠다. 그리고 조잡함

### 그냥 쓴다

이건 좀;;


### 결론

그냥 지역코드 도메인을 새로 만들고 푸시는 기존 쿼리방식 테이블로 만들기로
  - 일단 해봄
