---
title: "환율 서비스 일시 장애(20240531)"
date: 2024-06-05
tags: [미지정]
category: 기타
---
케이뱅크 환율 변동알림 서비스 장애가 났음(MSA 서비스 올라가있음)
다행히도 담당중인 주식 도메인은 장애건이 없었음

## 경과

5월 31일 12시 16분 첫 MCI > NLB 간 502 ERROR 발생 확인(밥먹고오니 날벼락, 환율 담당자분은 오후반차!!)
그 후로 5분 간격으로 NLB에 신호가 들어왔다 안들어왔다 오락가락
하지만 그 순간에도 NLB에 들어온 신호 중에 주식 api-gateway는 잘 응답함. 하지만 환율쪽 api-gateway에만 응답이 5분 주기로 들어왔다 안들어왔다 함
  - 하지만 담당자는 오후반차로 자리에없는 상황
다행인건 내 업무 api-gateway에서 로직 일부를 복붙해서 코드를 그나마 쉽게 볼 수 있었음
일단 exchange-service 파드 개수 늘리니 사라짐

## 원인파악


### 쿠버네티스에서 계속 환율 파드 재기동함

Redis 사용률이 80%를 넘어가는 이상한 상황 인지(Redis 관련 관제가 아직 없어서 이제껏 용량이 장기 우상향 하고 있던 사실을 몰랐음)
쿠버네티스에서 각 서비스에서 /actuator로 헬스체크를 하고 있는 상황인데 주식쪽 서비스들은 헬스체크가 잘 되는데 환율쪽은 2초가 넘어가서 fail로 뜨는 걸 인지 ⇒ 긴급 재기동을 계속 하다보니 재기동하면 일시적으로 들어옴 ⇒ 응답속도 늦어지니 또 재기동, 재기동하니 그동안 요청들 다 Fail ⇒ 5분 단위로 신호가 들어왔다 안들어왔다 했던것

### 재기동한 이유

환율 서비스는 Redis 캐싱을 사용함(Cacheable) → 레디스에서 응답이 2초 이상 지연되면 DB를 찌르다 보니 환율 서비스에 들어오는 요청량에 비해 자원이 부족 > 쿠버네티스에서 health check 를 하려고 /actuator를 찔렀는데 응답이 안와 > 재기동

### 왜 Redis 응답이 늦었나

레디스 사용량이 갑자기 증가함. 환율 api-gateway에서 request body 캐싱을 한 다음 캐시를 삭제해줘야 하는데 삭제하는 로직이 없었음(왜그러셨어요…)

### TTL 설정은?

yml 파일에 spring.data.redis.time-to-live : 3으로 설정되어있긴 했는데 cacheManager 로 ttl 명시를 하지 않아서 ttl이 자동으로 -1로 설정되어 들어가있었음. 그래서 4월 말부터 계속 캐시가 쌓이다가 폭발한것
기존에 개발할 때, redisTemplate으로 hash put 하는 로직에는 해당 옵션을 사용했는데, @Cacheable을 사용하는 경우에는 cacheManager Bean 선언을 통해 ttl을 명시적으로 선언해주어야 하는데, yml 파일에 기재만 하면 되는줄 아셨나 봄. 지금까지는 delete와 evict 가 둘 다 호출되어서 드러나지 않았는데, 해당 로직이 환율 게이트웨이에는 빠져서 ttl -1인 해시들이 계속 쌓임.

### 주식 서비스는 영향 없었던 이유

분명 같은 Global Redis를 사용하기 때문에 주식 업무에 영향이 있을것이라고 생각했는데 주식은 문제 없었음. 
  1. 공모주 메이트, 비상장 주식 알림 서비스는 TPS 상대적으로 낮았음
    1. 돈나무 이벤트 때문에 환율 서비스에 유입량이 많아서 유휴 커넥션이 없었던 것
  2. 그래서 파드 자원이 널널했음
    1. 레디스 응답이 안온게 아니라 속도의 문제였다. 2초가 넘어서 죽은 파드라고 생각했던 것
    2. /actuator가 레디스를 찌르는게 아니기 때문에 유휴 커넥션 자원이 있었으면 무조건 살았을 텐데.. 환율 파드의 모든 커넥션이 레디스에 묶여버려서 헬스체크 요청에 대응을 못했던 것. 반대로 공모주,비상장도 Postgre가 아니라 Redis에서 데이터 꺼냈으면 장애 났을 확률이 있음(다행히도 여기는 트래픽이 적었음)
  3. 똑같은 논리로 환율 pod를 4 → 6 개로 scale up 후 장애 사라짐
    1. 왜냐하면 유휴 커넥션이 많아져서 /actuator 호출에 대한 응답을 줄 만큼은 여유가 생긴것으로 판단

![](https://prod-files-secure.s3.us-west-2.amazonaws.com/c38aebd7-2834-4fac-b2fc-a2f0c17ce81d/625be741-d48e-4930-a819-21b33d8f8370/FinService_-_convenience_%EB%8C%80%EB%9E%B5_%EA%B5%AC%EC%A1%B0.jpg)



### 해결

1. 주식 게이트웨이에서 redis 캐싱 하지 않고 jvm 메모리 내부에서 해결되도록 수정 했었는데, 마침 관련 장애가 나서(?) 주식 gateway와 똑같이 수정하면 될것같다고 말씀드리고 소스코드 공유해 드렸다.
2. 편의서비스에서는  클러스터 통합 레디스가 아니라(놀랍게도 당시는 레디스 도입 초기라..) 저장소 캐싱 용 지역적인 레플리카가 필요하다고 말씀드렸다.
  - ⇒ 건의가 받아들여져서 각 단위업무별 샤딩된 레디스 레플리카를 제공해주셨다. 
