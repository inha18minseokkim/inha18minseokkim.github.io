---
title: "Java.lang.Concurrent.Flow"
date: 2023-08-17
tags: [미지정]
---

```java
package com.example.test;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

import java.util.Random;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Flow;


class TempInfo {
    public static final Random random = new Random();
    private final String town;
    private final int temp;
    public TempInfo(String town,int temp){
        this.town = town;
        this.temp = temp;
    }
    public static TempInfo fetch(String town){
        if(random.nextInt(10) == 0) throw new RuntimeException("Error!");
        return new TempInfo(town,random.nextInt(100));
    }
    @Override
    public String toString(){
        return town + " : " + temp;
    }
    public int getTemp(){return temp;}
    public String getTown(){return town;}
}

class TempSubscription implements Flow.Subscription{
    private final Flow.Subscriber<? super TempInfo> subscriber;
    private static final ExecutorService executor = Executors.newSingleThreadExecutor();
    private final String town;

    TempSubscription(Flow.Subscriber<? super TempInfo> subscriber, String town) {
        this.subscriber = subscriber;
        this.town = town;
    }

    @Override
    public void request(long n) {
        executor.submit(() -> {
            for (long i = 0L; i < n; i++) { //subscriber가 만든 요청을 한 개씩 반복
                try {
                    subscriber.onNext(TempInfo.fetch(town));//온도 가져오기
                } catch (Exception e) {
                    subscriber.onError(e);//온도 가져오기 실패하면 subscriber로 에러 전달
                    break;
                }
            }
        });
    }

    @Override
    public void cancel() {
        subscriber.onComplete();//구독 취소되면 onComplete신호를 subscriber로 전달
    }
}

class TempSubscriber implements Flow.Subscriber<TempInfo> {
    private Flow.Subscription subscription;

    @Override
    public void onSubscribe(Flow.Subscription subscription) {//구독을 저장하고 첫 번째 요청을 전달
        this.subscription = subscription;
        subscription.request(1);
    }

    @Override
    public void onNext(TempInfo item) {//수신한 온도를 출력하고 다음 정보를 요청
        System.out.println(item);
        subscription.request(1);
    }

    @Override
    public void onError(Throwable throwable) {//에러가 발생하면 에러메세지 출력
        System.out.println(throwable.getMessage());
    }

    @Override
    public void onComplete() {
        System.out.println("Done!");
    }
}
//processor는 subscriber이며 동시에 publisher, 재가공하는것
class TempProcessor implements Flow.Processor<TempInfo,TempInfo> {
    private Flow.Subscriber<? super TempInfo> subscriber;
    @Override
    public void subscribe(Flow.Subscriber<? super TempInfo> subscriber) {
        this.subscriber = subscriber;
    }

    @Override
    public void onSubscribe(Flow.Subscription subscription) {
        subscriber.onSubscribe(subscription);
    }

    @Override
    public void onNext(TempInfo item) {
        subscriber.onNext(new TempInfo(item.getTown(), (item.getTemp() - 32) * 5 / 9));
    }//섭씨 변환 후 TempInfo 재전송

    @Override
    public void onError(Throwable throwable) {
        subscriber.onError(throwable);
    }

    @Override
    public void onComplete() {
        subscriber.onComplete();
    }
}


@SpringBootApplication
public class TestApplication {
    private final static Logger log = LoggerFactory.getLogger(TestApplication.class);
    private static Flow.Publisher<TempInfo> getTemperatures(String town){//구독한 Subscriber에게 TempSubscription을 전송하는 publisher를 반환
        return subscriber -> subscriber.onSubscribe(new TempSubscription(subscriber,town));
    }
    private static Flow.Publisher<TempInfo> getCelsiusTemperature(String town){
        return subscriber -> {
            TempProcessor processor = new TempProcessor();
            processor.subscribe(subscriber);
            processor.onSubscribe(new TempSubscription(processor,town));
        };
    }
    public static void main(String[] args) {
        SpringApplication.run(TestApplication.class, args);
        //getTemperatures("New York").subscribe(new TempSubscriber());//뉴욕에 새 publisher만들고 TempSubscriber를 구독시킴
        getCelsiusTemperature("New York").subscribe(new TempSubscriber());
    }

}
```


### 

