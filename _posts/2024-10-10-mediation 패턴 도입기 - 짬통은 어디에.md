---
title: mediation 패턴 도입기 - 짬통은 어디에?
date: 2024-10-10
tags:
  - 개발
  - 아키텍처
  - Java
  - BFF
category:
  - 실무경험
---
Mediation 패턴 구현 과정 정리.
## 라우팅의 문제 - 레거시에서 바라보는 업무 분류와 MSA 환경에서의 업무 분류의 차이

현재 공모주, 비상장주식 서비스 개발 후에 상장, 해외주식 서비스까지 오픈된 상황이다.
모두 편의서비스 > 주식에서 내가 만든 서비스인데.. 하나의 서브도메인에 단위업무가 여러 가지 추가되다보니 몇 가지 에로사항이 있었다.
MCI에서는 어플리케이션 - 서브 어플리케이션 구조를 가지고 있고 MSA에서는 네임스페이스 - 서비스 구조를 사용하고 있다.

| 기존시스템 |  | MSA |  |
| --- | --- | --- | --- |
| 계 | 서브계 |  | (서브계) |
| 주제영역1 | 자산관리(ASM) | namespace | 편의서비스(CSV,convenience) |
| 주제영역2 | 주식(SCK) | svc | 주식(STK,stock) |
|  | 하위는 사실상 별다른 구분없음 | 단위업무 | 공모주(convenience/stock/ipo-service) |
| 주제영역2 | 식품물가(FDP) | 단위업무 | 비상장(convenience/stock/unlisted-stock-service) |
| 주제영역1 | 카드(CRD) |  | 국내(convenience/stock/listed-stock-service) |
| 주제영역2 | 승인 |  | 해외(convenience/stock/overseas-stock-service) |
| 주제영역2 | 정산 | svc | 지수(IDX,index) |
|  |  | 단위업무 | 주가지수 |
|  |  |  |  |

어거지로 매핑을 해도 MSA 쪽이 한 depth 더 내려가기 때문에 기존 레거시 시스템과 아다리가 맞지 않다.
서브계>카드>승인 이고 서브계>편의서비스>주식>공모주. 
MCI 어댑터의 경우 주제영역1 까지만 uri 커넥터 매핑을 해준다.
기존서비스의 경우 서브계>카드(CRD) 로 MCI 어댑터를 추가하고 신규업무가 추가되는 구조가 아니지만
MSA쪽 편의서비스의 경우 서브계>편의서비스>주식(STK) 로 MCI를 추가하게 되면 하위 경로로 분기를 칠 수 없는 구조이다.
그렇다면 서브계>편의서비스>주식>? 로 새로운 서비스가 만들어질 때 마다 MCI 어댑터를 추가해야 하는데, 그렇게 되면 빠르게 개발되어야 하는 서비스 특성상 MCI쪽에서 대응이 안되어 개발작업이 늦어지게 되고, 애초에 MCI가 어댑터를 무한정 늘리는 식으로 설계되어 있는 솔루션이 아니다보니 현실적인 한계에 부딪혔다

그렇게 해서 처음에 제안했던 방식이 /convenience/stock/서비스코드, 즉 뒤에 서비스코드만 붙여주면 spring cloud gateway 에서 라우팅 할 때 규칙을 만들어 분기를 치는 것이었다. 마감 시한이 정해져있었기 때문에 리스크 없는 간단한 방식이었다. 다행히 MCI 담당자분도 뒤에 서비스코드 정도는 붙여줄 수 있다고 했다.

# 서비스간 상호 호출의 문제 - 단일 db로 인한 가능성

다음과 같은 문제가 존재했고, 여전히 남아있었다.
1. 라우팅 규칙에 if ~ else와 같은 로직이 들어감


2. 그리고 그 로직이 깔끔하지 못했다
3. 서비스들 간의 상호 호출 문제
우선 라우팅 규칙에 if ~ else 형식이 들어가는 것은 로직이 덕지덕지이긴 했지만 업무가 추가되는 속도가 그렇게 빠르지 않다보니 2순위 문제였긴 했다.
그렇긴 해도 Mediation 패턴을 도입하면 위 세 가지 문제를 모두 해결할 수 있을 것 같았다.

![](https://prod-files-secure.s3.us-west-2.amazonaws.com/c38aebd7-2834-4fac-b2fc-a2f0c17ce81d/64cf8b2f-2ecf-4bf8-918f-28a45ee9042c/image.png)

우선 2순위 문제였던 MCI > MSA 라우팅 규칙이 깔끔해졌다
기존에는 CSVSTK1~ → 공모주, CSVSTK2 → 비상장 으로 라우팅을 하면서 3번은 상장, 4번은 해외 이런식으로 덕지덕지 추가가 되었을 것이다.(if else ~ else ~ else와 같은 패턴 반복)
하지만 mediation 파드를 도입하면서 api-gateway는 MCI 에서 오는 요청을 받아서 케이뱅크 레거시 표준헤더를 파싱하고 처리, 로깅해주는(…이것도 문제가 많다) 행동만 집중할 수 있고
mediation 파드에서 라우팅 + 조합을 하기 때문에 말단 서비스들의 로직이 간단해진다.
저 당시까지만 해도 controller - service - infra 3 레이어 구조를 고수하고 있어서 결국 서비스 레이어에서 다른 서비스들을 호출하면서 흔히 말하는 짬통 서비스가 하나씩 있었는데, 이렇게 되다보니 다른 사람과 협업하는 부분에서 서비스 호출의 depth가 점점 늘어날 수도 있는 상황이었다.

![](https://prod-files-secure.s3.us-west-2.amazonaws.com/c38aebd7-2834-4fac-b2fc-a2f0c17ce81d/840b03dd-89dc-4d7c-ab65-0bfe420308bc/image.png)

이런식으로 서비스간의 상호 호출을 규칙없이 허용하다 보면….어떻게 될까.

## Facade 레이어는 쓰지 않기로 함


![](https://prod-files-secure.s3.us-west-2.amazonaws.com/c38aebd7-2834-4fac-b2fc-a2f0c17ce81d/5458736b-8394-4c2e-a7c4-21634157639c/image.png)

처음에는  controller - service 레이어 사이에 facade 패턴을 넣자고 주장은 했지만, 다른 분들의 거센 반대로 인해 캔슬되었고(당시 공모주 메이트 서비스를 카드 서버에서 MSA로 최초 마이그 중이었는데, 간단한 서비스에 비해 해야할 것이 너무 많아서, 매퍼도 추가해야되고)
나 또한 근본적으로 파사드 레이어를 중간에 넣는다고 해결되지 않는 것들도 있다고 판단했다.
다만 현재 주식 서비스들이 후에 좀 더 고도화 된다면(될까??? 공모주 메이트 서비스 출시한지 2년 가까이 되가는데 초기 말고 고도화 논의 없음) 필요해 질 수도 있기 때문에 도입 여지는 남겨놓는다.

## pod 상호 호출 까지 가능


![](https://prod-files-secure.s3.us-west-2.amazonaws.com/c38aebd7-2834-4fac-b2fc-a2f0c17ce81d/4756e7d0-5a98-4d54-93b8-3344c0363022/image.png)

이런말하기는 부끄럽지만 공모주, 비상장, 국내, 해외, 지수, 환율, 방송, 퀴즈쇼, 수신이벤트, 가상자산 다 한 DB에 들어가있다.

![](https://prod-files-secure.s3.us-west-2.amazonaws.com/c38aebd7-2834-4fac-b2fc-a2f0c17ce81d/9ec80fce-30a0-4e62-96b6-1e70f75c637c/image.png)

백엔드는 MSA 구조가 맞는데 프론트엔드와 DB(물리)는 완전 모놀리틱이다. 아니 모놀리틱도 이정도는 아니다. 그냥 우리집 장난감용 맥미니에 올라가있는 쿠버네티스 - db와 구성이 비슷하다.
만약 위 db에서 장애가 발생하면 총 8개, 그 이상의 서비스가 모두 안된다. 실제로 비슷한 일이 있었다.

그리고 메타 구조상 STK(주식) 의 하위 서비스는 모두 한 서브도메인이기 때문에 같은 DataBase(논리)를 사용한다.
그러므로 공모주 메이트 서비스를 위해 만들어진 테이블을 비상장 주식에서 바로 콜 할 수 있다. 논리적으로 같은 db를 참조하고 있으니 말이다.
이는 지금으로서는 큰 문제는 아닌데, 후에 각 주식 서비스들간의 강결합이 형성되어 특정 업무의 유지 보수에 영향을 미칠까 심히 걱정된다.
  - 하지만 당시의 나 조차도 비상장 주식의 공모 여부를 검색하기 위해 비상장 주식 어플리케이션에서 공모주 메이트 테이블을 참조하는 실수(아니 고의임, 당시 mediation 도입은 과한 엔지니어링일 수도 있다는 피드백을 들었음. 그래서 신규 서비스가 주식에 생기면 도입하겠다고 합의했고 투자홈 서비스가 나와버려서 이번에 들어가는 것)를 저질렀고, 현재도 잘 서비스를 하는 중이다…현재는
이번에 투자홈 서비스 개발하면서 mediation 파드를 도입했으므로 공모주 메이트와 비상장 주식 알림 서비스와의 강결합을 끊어낼 예정이다.(완료)

### ASIS)

비상장 주식 알림 서비스에서 공모주 테이블과 비상장 테이블 join

### TOBE)

비상장 주식 알림 서비스에서 공모주 메이트 api를 call
물론 리스트이므로 mediation 패턴의 경우 N+1 문제와 유사한 문제가 생길 수 있는데,  유의하며 개발해보는걸로 함.

![](https://prod-files-secure.s3.us-west-2.amazonaws.com/c38aebd7-2834-4fac-b2fc-a2f0c17ce81d/61d15cdc-e69f-4794-a17c-8c16f3f39d09/image.png)

깔끔(DB는 안깔끔, 환율 지수는 내 담당이 아니라 못함. + 아직 신규 하위업무가 없어서 필요없을듯)
