---
title: "Python - ISTIO 사이드카 연동 문제(사이드카보다 파이썬 외부 연결이 더 빨라,20250317)"
date: 2025-03-16
tags: [미지정]
category:
  - 기술
---

## 상황

Python 스크립트를 만들고 python 이미지 반입하여(apt로 clib 관련 라이브러리 설치는 외부망에서 하고 반입)
로컬 환경에서 파이썬 스크립트가 정상 작동하는것을 보고 

해당 프로젝트처럼 스테이징환경에 배포를 하였는데(확실히 스프링 부트 이미지 빌드보다 빠름. 레이어링 끝난 다음 복사배포만 하면 끝이니깐)
기동 시 db연결 불가, IDC 카프카 연결 불가 pod간 통신 불가 등등.. 파이썬 컨테이너 환경에서 네트워크 신호가 밖으로 나가지 못하는 현상 발생. 무조건 connection refused


### 원인

[Connection refused error in outbound request in k8s app container. Istio?](https://stackoverflow.com/questions/63481969/connection-refused-error-in-outbound-request-in-k8s-app-container-istio)
위 글을 보고 제발 파이썬 기동할 때 30초만 슬립을 걸어보자고 떼를 썼는데 결국 됨. (왜 말도안되는 소리라고 들었지..)
기존에 사용하던 Spring Boot 어플리케이션의 경우 아무래도 뜨는데 오래 걸리니깐(파이썬보다 상대적으로 느림. 공통 dependency 관련 라이브러리 로드하고 빈주입하고 클래스 올리고 등등..) 무조건 이스티오가 더 빨리 떴을것임.
 파이썬의 경우 이미지가 캐싱만 되어있으면 바로 파이썬 파일이 뜨는 형태다 보니 + 파이썬 이미지 기동 후 제일 먼저하는게 아마 DB 커넥션, 외부 콜 같은 행동일테니 이 때 이스티오 사이드카보다 외부 호출이 먼저 일어나는 것 같음.


### 해결방법

1. Python 시작할 때 1초 정도 Time.Sleep을 준다
  1. 코드가 더러워 보여서 하기 싫음. 비즈니스 로직에는 비즈니스 로직만.
2. argo workflow 에서 전단계 step을 만들어줌
  1. 아래와 같은 예시인데, 결국 이것도 1번이랑 크게 다를건 없음.

```kotlin
command: ["/bin/bash", "-c"]
args: ["until curl --head 아무헬스체크용서버:포트 ; do echo Waiting for Sidecar; sleep 3 ; done ; echo Sidecar available; ./시작스크립트 또는 다음단계로 넘어가"] 
```


1. 꼭 정기작업에 사이드카를 붙여야 할 까
  1. WAS 말고 POD JOB은 붙이지 말자고 주장
  2. 물론 호출의 dependency나 로깅을 보기 위해서 이스티오를 도입한것이기 때문에 받아들여지지 않을 확률이 높음
2. 뭔가 pod단에서 sidecar proxy가 initialize 되고 난 다음에 시작하는 옵션이 있을 것 같지만, 찾을 수 없었다
  1. 이스티오가 쿠버네티스 네이티브 옵션이 아니라 그런가?
  2. 이런 옵션이 있긴 하다.([https://istio.io/latest/docs/ops/common-problems/injection/](https://istio.io/latest/docs/ops/common-problems/injection/))

```kotlin
proxy.istio.io/config: '{ "holdApplicationUntilProxyStarts": true }'
```

⇒ 4번으로 채택
