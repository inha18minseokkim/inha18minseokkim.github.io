---
title: 검색 기능 고도화 신규 개발(20241001, 비상장주식도 같이?)
date: 2024-09-11
tags:
  - 기획
  - 개발
  - 아키텍처
category:
  - 실무경험
  - 비상장주식알림서비스
---
국내주식과 해외주식 을 한 창에서 검색할 수 있게 구현해야 한다.
기존 케이뱅크 내부에는 검색에 대한 레퍼런스가 없음.
비상장주식도 검색기능 BM이 시간도 없는데 그냥 SQL LIKE로 걸자고 해서 걸어놨는데 용납할 수 없음. 너무 조악해
상장,비상장,해외주식 모두 다 동시에 검색할 수 있게 만들어 놓자(물론 비상장주식이 투자홈에 들어오진 않겠지만, 혹시 몰라? 건의하면 받아들여질 수도 있음)
현재 해결해야 할 문제와 기술상 한계는 다음과 같음 (아니 다른분들은 별 생각없는것 같은데 나는 문제라고 생각함)
1. 검색창은 하나, 서비스는 3개(비상장,상장,해외), 데이터소스는 5개(국내주식 테이블 2개, 해외주식 테이블 2개)
2. 한글이름을 검색하면 영어도 나왔으면 좋겠다
3. (제일 심각) 채널 - MCI - MSA 구간이 너무 느리다. 네이버 검색창에 이런식으로 치면 바로 밑에 추천 검색어가 쭉 나오는데, 케이뱅크에서 비상장주식할 때 이걸 해봄. 근데 프론트에서 백으로 왔다 갔다 하는 시간이 너무 느린데다 프론트엔드 솔루션의 기술적 한계 문제인지 호출할 때 마다 화면에 골뱅이 돌면서 버벅임. 

![이미지](/assets/images/Pasted%20image%2020260226163608.png)

4. 단순 LIKE로 걸면 음운별 검색이 안된다. 케ㅇ 이렇게 오타를 내고 검색 했을때도 케이뱅크가 나오면 좋겠는데, LIKE로 걸면 안나옴.

![이미지](/assets/images/Pasted%20image%2020260226163612.png)

5. 종목코드번호로도 검색이 가능?


### 일단 3번 문제는 현재 스펙상 해결할 수 없다고 생각한다. 비상장 주식때도 해결을 못했었다. 현재 케이뱅크 프론트 - MCI 기술스펙의 문제이다.

⇒ 채널개발자분이 협조해주시면 캐싱로직으로 가능해요 ㅜㅜㅜㅜㅜ
식품물가 검색은 채널쪽에 검색 대상데이터를 모두 넘겼기때문에(즉 채널통합관리자 db에 수기로 등록) 채널에서 빠르게 검색이 가능했다. 식품 수는 108개로 거의 바뀌지 않기 때문에 수기로 등록이 가능했다.
비상장 주식의 경우 두나무쪽에서 신규 등록, 등록 해제(상장 상폐는 아니므로) 등 대상종목의 변동이 빈번하여 하지 못했다. 
~~아마 비상장 주식 페이지에 들어올 때 마다 종목코드 - 종목 명 kv 값 리스트를 싹 던져주고 프론트에서 알아서 검색하라고 하면 될 것 같기는 한데, 종목 수가 너무많아서 쉽지 않다(비상장종목 5천종목정도 있었고 상장종목 4천개, 해외주식 7천개 정도) ~~⇒해결 가능해진듯
결국에 채널관리자화면, 즉 프론트엔드에서 캐시 성격으로 쓸 수 있는 데이터소스에 밀어넣어줘야 하는데 현재 그런 기능은 없다. 답답하지만 키워드를 검색할 때 마다 로딩이 걸리는건..지켜볼 수 밖에 없는 것 같다 ㅜㅜ

### 1번 문제는 이번 투자홈 개발하면서 도입한 mediation api 파드가 해결해줄 수 있을 것 같다.



![이미지](/assets/images/Pasted%20image%2020260226163618.png)

이런식으로 조합을 하는것도 방법인듯 하다. 다만 우려되는 점은 mediation에 자꾸 비즈니스 로직이 들어가는 것 같아 마음에 걸린다. 한 가지 관리포인트가 더 추가되므로 mediation 자체에 부담이 가는 일은 없었으면 좋겠다.
아니면 별도의 redis repository를 다루는 서비스를 만들어 검색 전담으로 분리하는것도 방법. (주식 공통 서비스를 하나 만들어. 어차피 주식 영업일 캘린더도 만들어야해서 주식 도메인에서 사용할 공통 로직들을 따로 분류해도 될듯)
둘 중에 무슨 방법을 사용할지는, 조금 더 고민해보겠다.

### 4번 문제는 한글 음운 분리를 하면 해결될 듯 하다.

ex) 케이뱅크 > ㅋㅔㅇㅣㅂㅐㅇㅋㅡ 로 분리하고 케이 검색어가 들어오면 ㅋㅔㅇㅣ 로 분리해서 질의를 날리면 될 듯. 역시 찾아보니 누군가가 이미 해놓음 ㄷㄷㄷ
  - [한글 검색기 만들기](https://wordbe.tistory.com/291)

### 2번 5번 문제는 같이 보자. 비상장,상장,해외 주식을 별개로 보지말고 검색을 위한 키워드 필드를 하나 더 만든다고 생각해보자.

각 데이터의 인식가능한 필드를 찾아보면
비상장주식 : 종목코드번호(6자리), 주식한글명
  - 279570, 케이뱅크 이거 두개밖에 없어
국내상장주식: 종목코드번호(6자리), 주식한글명, 주식축약명, 주식영문명

```java
            "name_short": "에스케이하이닉스",
            "entity_name_ko": "SK하이닉스",
            "entity_name_en": "SK hynix",
```

해외주식: 티커(1~5자리), 주식한글명, 주식영문명, 주식축약명

```java
        "name": "Apple Inc",
        "name_ko": "애플",
        "name_short": "Apple",
```

단순하게 생각해보면, redis에 해시값으로 넣는다고 치면

```java
{”key” : “SEARCH:279570ㅋㅔㅇㅣㅂㅐㅇㅋㅡ”
, “value”: {”종류” : “비상장”, “id” : “279570”}}
{”key” : “SEARCH:000660ㅇㅔㅅㅡㅋㅔㅇㅣㅎㅏㅇㅣㄴㅣㄱㅅㅡSKㅎㅏㅇㅣㄴㅣㄱㅅㅡSK hynix”
, “value” : {“종류” : “상장”, “id” : “000660”}}
{”key" : “SEARCH:AAPLApple IncㅇㅐㅍㅡㄹApple”
, “value” : { “종류” : “해외”, “id” : “AAPL”}}
```

이런식으로 대략 2만개의 hashset이 생성됨. 이걸 그대로 일단 넣는다고 쳐
  - 성능문제는 일단 2만개정도면 괜찮을것같으니 해보고 문제생기면 조금 바꿔
  - 약간 신경쓰이는것은 유니코드 문제와 키값 길이 문제.
keys SEARCH:*ㅋㅔ* 이런 식으로 하면 큰일날 것 같고 scan을 사용해야할것같음.
  - 싱글스레드로 동작하는 레디스 특성상 아무리 2만개 적은거라 하더라도 패턴 매치하는것이다보니 조심스럽게 다가가려고 함. O(N) 풀스캔은 위험하지 ㅇㅇ
[Redis의 SCAN은 어떻게 동작하는가? - tech.kakao.com](https://tech.kakao.com/posts/314)
[Redis KEYS vs SCAN](https://velog.io/@sejinkim/Redis-KEYS-vs-SCAN)
이 두 글을 보고 이정도는 괜찮을 것 같다고 판단함.

### pattern match 대신 LCS와 비슷한 감성으로 검색한다면?

이건 레디스 scan으로 해결할 문제가 아니라 jvm 메모리 내부에서 처리할 문제인것같음. 
만약 위와 같이 redis scan 알고리즘을 사용한다면 redis에서 검색한 내용을 그대로 말아서 보여주는것이고
LCS 기반 매칭을 생각한다면 redis 의 list로 하나에 있는 리스트를 싹 긁어온 다음 자바에서 패턴매칭을 수행하는식으로 될듯.
일단 like 검색 구현해 보고 생각하자.


## MCI 타면 안됨

3번 문제를 보고 이거 채널에서 하루에 한 번 리스트 주면 알아서 검색로직 만들면 안되나라는 생각을 했는데 그거 된다고 하심. 하루에 종목 한 번씩 변동한다고 하면 채널 캐싱 주기 하루 두고 종목코드 리스트 뿌려주면 부드럽게 자동완성 될듯.
비상장주식 알림 서비스도 이렇게 만들면 될듯. 안바쁘시면 해달라고 하자..
이러면 레디스에 내용들 저장할 필요 없이 mediation에서 한 번만 채널에 리턴해주고 캐싱해서 쓰면 될듯.




