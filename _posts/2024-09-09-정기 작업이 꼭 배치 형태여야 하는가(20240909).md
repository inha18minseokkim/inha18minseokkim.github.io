---
title: "정기 작업이 꼭 배치 형태여야 하는가(20240909)"
date: 2024-09-09
tags:
  - 개발
  - 기획
  - 주식서비스
category:
  - 실무경험
---
주식 게임 서비스 개발 및 기획 논의 정리.
### 배경

보통 jflow에서 정기작업(scheduled job)을 개발하고 운영할 때 보통 99% 배치임
  - 아마 솔루션회사가 프레임워크 표준 잡을 때 그러는 것 같음
레거시 환경에서는 batch 어플리케이션이 올라가 있고 .class 파일 컴파일, 운영 배포 후 jflow에서 트리거가 날아가면 .class를 호출하는 스크립트를 실행하는 식으로 정기작업이 돌아감
레거시 환경 같은 경우는 배치 잡이나 db커넥션, 외부 인터페이스 등이 모두 개발되어 있음(카드계, 방카슈랑스, 계정계 등) 
  - 그래서 레거시 환경에서는 정기작업 개발을 할 때 별 세팅 없이 비즈니스 로직만 개발하면 끝났다(레퍼런스가 많고, 이미 프레임워크가 해당 업무에 최적화되어있을 확률이 높음, db Select 하는 로직이나..트랜잭션 레벨 설정하는것, Spring bean 관련 세팅 등)


### MSA 환경에서의 한계

MSA 환경에서는 처음부터 구축…구축 해야함
그리고 기존 계정계와는 다르게 업무의 성격이 다양함… 너무 다양함
  - 기존 카드업무의 경우 DB Select → DB Select, File → DB, 또는 동기 온라인 EAI Call 의 유형의 99.99% 이므로 최적화된 Bxm Bean을 사용할 수 있었지만, 주식 개발 하면서 kafka,redis 등등…도입이 됨
그러므로 MSA 환경에서 어쩌면 필요하지 않을지도 모르는 배치 작업을 위한 공통파드를 구축 단계에서부터 계속 분석설계하면서 만들거냐..? 그건 아니다 라고 결론 내림
그래서 왜 이걸 처음에 배치로 꼭 만들어야하냐 라고 돌아다니면서 알아봤는데 명쾌한 대답을 찾지 못했기 때문에(컴플라이언스 요건도 아님) 그냥 투자홈 구축할 때는 배치를 안쓰기로 함.

### 투자홈 구축의 예


투자홈의 경우 OpenApi 솔루션으로 대외 찌르기 위해 Pub을 하는 정기잡을 개발했다. 보통같으면 해당 작업도 배치로 개발해야하는데 굳이 배치를 개발 할 필요가 없었다. 사유는
  1. batch db select하고 잡 초기화하고 느리고 무거워
    1. 1분, 5분에 한번씩 도는 잡의 경우 오차가 20초, 30초가 되어버리면 간간히 중복실행 되는 경우가 있더라. 배치 형태는 적절하지 않음. 빨리 띄우고 빨리 꺼져야 함.
  2. db transaction을 보장할 필요가 없었음
    1. 해당 잡의 목적은 kafka topic Pub 그 이상 이하도 아니었다
    2. 카프카 트랜잭션이라 하더라도 의미가 없다. 저쪽에서 sub을 해야 대외로 찌른다. 
    3. pub을 batch commit 하면 오히려 api쪽에서 한번에 호출을 몰아서 할 수 있음 → 상대 기관에 폭탄 날리는 꼴

### 아니 그러면 그냥 데몬으로 띄워놓고 Spring Scheduler 나 Quartz를 쓰면 안되나?

안됨 ;;
  1. 현재 MSA 환경에서 계정계 영업일 판단을 할 수 없어서 계정계 jFlow의 트리거가 필요했던 상황.
  - 만약 영업일 판단과 상관없이 무조건 5분에 한 번 호출이었으면 온라인으로 호출했을 것.
  1. 라고 답변을 하고싶지만, 온라인 파드에 장애가 나는 경우 현재 대응이 불가하다고 생각한다. SRE가 출근해서 파드 내려야됨.

    - 그래서 이런 구조가 탄생..
  2. 만약 계정계 공통업무(여기서는 Jflow 영업일 테이블)가 넘어오면 Spring scheduled나 Argo workflow의 cronJob을 사용할 의향이 있긴하다. 파드 제어가 안된다는 문제가 있긴한데, 이건 SRE와 논의해서 jFlow에서 관제 할 수 있는 기능을 개발하면…되겠지?
    - kubectl delete pod명령어를 jflow에서 날리면 좋겠지만.. 될까?
    - ~~뭔가 테이블이 아니라 api 형식으로 들어오면 더 좋을 듯 하다.~~
      - 생각해보니 그러면 api에 의존해야하므로 그냥 etl 사용해서 계정계 영업일테이블을 공유받고 그 테이블에서 자유로운 로직 + 많이 쓰는 로직은 라이브러리 공통화 하는것이 적절해 보인다.