---
title: 수신 캐시백 지급프로세스 트랜잭션
date: 2024-01-17
tags:
  - 케이뱅크
  - 게임
  - 동시성
  - 개발
  - 기획
category: 실무경험
---

1. 사용자가 나무에 물주기 한다
  1. 물주기 서비스 request
2. 레벨업 (5원 캐시백 해줘야함)
  1. DB에서 경험치를 1→ 2 이런식으로 올려줌
  2. 경험치가 일정 수치에 도달한걸 봄
  3. 도달했으니 레벨을 올림
3. 5원 캐시백 지급
  1. 2번 프로세스에 이어서 EAI 수신 캐시백 요청
    1. 수신캐시백 요청이력 테이블에 이력 insert
  2. 정상 응답 받으면   response
    1. 이력 테이블에 update
    2. 후에 정상종료

문제는 2.a에서 성공 후 3에서 실패
  - 만약에 수신 response 실패 시 다시 시도를 위한 롤백을 해야 함
  - 일단 레벨업을 해놓고(커밋) 수신쪽 동기화 실패 시 우리쪽에서 롤백하는(DB롤백이 아니라 update 했던 내용을 다시 돌리는 코드) 하자고 하는데 이걸 다 구현하는건 좀 그렇다고 함.
그럴 바에는 그냥 
  - 경험치 올리고 레벨업 시키고 수신요청 비동기로 하자
  - 비동기로 한다음에 실패나면 저장되어있던 로그 기반으로 수신 캐시백 재요청하는 후행 프로세스를 만들어
  - 라고 일단 주장함. 사실 강하게 주장함.
  - 왜냐하면 대부분의 게임의 경우도 
    - 보상을 바로 넣어주는 경우가 있고
    - 좀 위험한 보상의 경우는 그냥 비동기로 처리함. → 어차피 후행은 계정계 서비스이므로 영향이 없음 + 센터컷의 경우 거의 준실시간으로 돌아서 괜춘
    - 가끔가다가 보상 트리거가 있는 아이템을 썼는데 잠시 후 다시시도해주세요 같이 커넥션 풀을 관리하는 곳도 있음(ㅁㅇㅍㅅㅌㄹ…) → 요건 상 게임 진행 경험을 저해함.

결론 
  - 일단 우리가 이력을 남기는걸 끝내고 수신쪽으로 비동기 콜 하자
  - 실패하더라도 우리쪽에 DB Write는 한 트랜잭션 안에 다 끝났으므로
  - 실패하면 1. 그냥 안주던가 2. 후행으로 주던가 3. BM이 보내던가(여기까진 안올듯)로 하기로 함
아쉬웠던 것은
  - kafka 마냥 우리가 푸시 해주면 저쪽에서 consume 해주는 방식으로 구현하면 좋겠지만
  - kafka는 현재 도입 단계이므로 일정을 못맞춤
  - 행내 UMS 처럼 DB 적재 하면 EAI 에서 적재 된 DB 내용 중 자기들이 아직 처리 안한 내용 긁어서 발송하는 방식(Decoupled + 이력 + 통신) 으로 처음에 고려했어야 했다.. 비슷하게 만들었어야
