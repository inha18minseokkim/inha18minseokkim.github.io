---
title: "메이플스토리 서버 장애 롤백으로 보는 SAGA 패턴의 운영상 문제점"
date: 2025-12-12
tags: [분산시스템, SAGA, 아키텍처, 장애분석, 메이플]
---

2025년 12월 12일 밤 10시쯤 메이플스토리 스카니아 서버가 장애가 나서 몇 시간 전으로 데이터가 롤백되었다. 메이플 유저 + 서버 개발자 입장에서 왜 이런 문제가 생겼는지 분석해봤다.

## 배경: 전 서버 경매장 통합

이번 스카니아 롤백이 특히 주목받은 이유는, **전 서버 경매장 통합 이후 처음 난 롤백 사태**이기 때문이다.

기존(ASIS): 각 서버(스카니아, 베라, 크로아...)의 경매장이 개별적으로 존재했다.

```
[스카니아 서버] ──→ [스카니아 경매장]
[베라 서버]    ──→ [베라 경매장]
[크로아 서버]  ──→ [크로아 경매장]
[캐시샵]       (공통)
[메소마켓]     (공통)
```

이때는 스카니아 서버에 장애가 나도 스카니아만 롤백하면 됐다.

---

## 전 서버 통합 이후 문제

경매장이 전 서버 통합되면 구조가 이렇게 바뀐다:

```
[스카니아 서버] ─┐
[베라 서버]    ─┤
[크로아 서버]  ─┼──→ [통합 경매장]
...             ─┘
[캐시샵]         ──→ (공통)
[메소마켓]       ──→ (공통)
```

스카니아 서버만 롤백하면 **통합 경매장에 올라가 있던 스카니아 유저의 아이템**은 어떻게 되는가?

- 롤백 전: 아이템이 스카니아 서버에서 출금되어 통합 경매장에 올라가 있는 상태
- 롤백 후: 스카니아 서버에서는 해당 아이템이 다시 인벤에 있는 것으로 처리
- 결과: **아이템이 경매장과 인벤에 동시에 존재하는 복제 현상**

커뮤니티에 이미 이런 복제 관련 글이 올라왔다.

---

## SAGA 패턴으로 보는 문제

분산 시스템에서 여러 서비스에 걸친 트랜잭션을 관리하는 패턴이 SAGA 패턴이다.

메이플 경매장 아이템 등록 과정을 모델링하면:

1. **스카니아 서버**: 유저 인벤에서 아이템 제거
2. **통합 경매장**: 해당 아이템 리스팅 추가

이 두 단계가 원자적으로(atomically) 처리되어야 하는데, 분산 환경에서는 이게 어렵다.

### SAGA의 보상 트랜잭션 문제

SAGA 패턴은 실패 시 역방향으로 **보상 트랜잭션(compensating transaction)**을 실행한다.

스카니아 서버 장애 → 스카니아 서버 롤백:
- 이미 통합 경매장에 올라간 아이템은 어떻게 처리?
- 보상 트랜잭션을 자동으로 실행해서 경매장에서 제거해야 함
- 하지만 롤백 시점에 그 경매장 아이템이 이미 다른 유저에게 팔렸다면?

복잡도가 기하급수적으로 올라간다.

---

## 캐시샵은 왜 상대적으로 괜찮은가

캐시샵의 경우 PG사(외부 결제) 트랜잭션이 핵심이다. 결제는 이미 완료된 상태에서 캐시만 지급하는 구조이기 때문에, 특정 서버 롤백 시에도 캐시 지급 처리를 독립적으로 관리하기 상대적으로 쉽다.

반면 서버 간 아이템 이동(경매장)은 양쪽 서버 상태가 모두 일관성을 유지해야 해서 훨씬 복잡하다.

---

## 서버 개발자 관점의 교훈

전 서버 통합 같은 **분산 트랜잭션 범위 확장**은 단순히 기능 확장이 아니라 **장애 복구 시나리오도 같이 설계**되어야 한다.

- 롤백 범위는? (특정 서버만 vs 전체)
- 롤백 시 연관 서비스(통합 경매장)에 대한 보상 트랜잭션은?
- 롤백 중 신규 트랜잭션 차단은?

"빠르게 붙이고 나중에 고친다"가 분산 시스템에서는 운영 사고로 이어질 수 있다는 걸 보여주는 사례다.
