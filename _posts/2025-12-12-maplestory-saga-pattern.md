---
title: "DDONGLE) 메이플 서버 장애 후 롤백으로 보는 SAGA 패턴의 운영상 문제점"
date: 2025-12-12
tags: [분산시스템, SAGA, 아키텍처, 장애분석, 메이플]
category: 실무경험
---

2025년 12월 12일 밤 10시쯤 스카니아 서버가 문제가 생겨서 몇 시간 전으로 데이터가 롤백되었다.

그리고 다음과 같은 글이 올라왔다.

![이미지](/assets/images/Pasted%20image%2020260220153820.png)

아이템이 복사된 사례는 되게 많은데(사기당한 아이템을 돌려줘야 하는데 이미 세탁되어서 풀린 아이템을 거래 된 경로를 다 롤백할 수는 없으므로) 이런식으로 뭔가 아이템의 식별자? 까지 같아서 경매장에 있는 매물이 현재 장착 중인 장비 라고 뜨는 기이한 현상까지 생겼다. **이건 명백히 복사된 지 얼마안된 따끈따끈한 장비임에 틀림없다.**

특히 이번 스카니아 롤백 사태는 전 서버 경매장 통합이 되고 난 다음 처음으로 난 롤백 사태이기 때문에 약간 관심있게 보고 있는 편이던 차에 벌써 이런 사례가 나와버렸다.

메이플 서버에 대해 잘 알지는 못하지만 서버 개발자 입장에서 왜 이런 문제가 생겼는지에 대해 한번 개인적인 생각을 말해보면서 공부를 해보도록 하겠다.

![이미지](/assets/images/Pasted%20image%2020260220153829.png)

ASIS 3대장 서버, 각 서버의 경매장, 전서버 통합 메소마켓, 캐시샵 상상도

캐시샵, 메소마켓 빼고 원래는 각 서버의 경매장이 따로 있었고 서버가 실패하는 경우 각각의 서버만 롤백 하면 가능했었다.

### 캐시샵

캐시샵의 경우 사실상 서버라기 보다는 하나의 로직에 가깝기 때문에 전 서버 통합이라 하더라도 신경쓸 일이 별로 없을 것 같다. 오히려 대외 PG사와의 트랜잭션 관리가 더 중요해 보인다.

아이템 구매 및 판매가 양방향이 아닌 일방향으로만 일어나기 때문에 각 서버 db 안에서의 트랜잭션만 신경 쓰면 된다.

캐시 아이템 이동(스카니아 > 루나로 캐시 보관함에 있는 캐시 이동)의 경우에도 쌍방의 고객 사이에서 일어나는 거래가 아닌 개인 고객에서 일어나는 일이므로 로그만 잘 쌓아놓으면 문제 시 운영으로 해결 가능할 듯 하다.

### 메소마켓

메소마켓의 경우 위와 같이 롤백을 할 때 돈 복사 문제가 생길 수는 있다. 가령

> 스카니아에서 유저 a가 1억 메소를 2000 메이플포인트에 판매
> 
> 엘리시움에서 유저 b가 1억 메소를 2000 메이플포인트에 구매

양방향 동시호가 거래이지만 이런식으로 거래가 성사되었다고 쳤을 때 스카니아 서버가 롤백되었다고 하면

> 유저 a는 1억 메소를 가지게 된다(원래는 2000메이플 포인트를 가졌지만 롤백)
> 
> 유저 b는 1억 메소를 가지게 된다(구매 하였지만 롤백되지 않았으므로)

결과적으로 2000 메이플 포인트는 사라지고 1억 메소는 증가하게 되어 균형 상태였던 환율에 문제가 생길 수 있다는 결론이 내려진다.

만 1. 이미 균형 상태인 환율이므로 각 통화의 흐름이 거의 등가교환 수준일 것 2. 손해보는 고객이 없고 아이템과 다르게 표면적인 문제는 보이지 않으므로 지금까지는 게임경제에 악영향을 미치거나 그럴 일은 없었을 것 같다.

![이미지](/assets/images/Pasted%20image%2020260220153840.png)

TOBE 경매장이 통합되어버린 상황

경매장이 통합되어 버린 상황에서는 특정 서버에서 시작된 장애가 다른 서버로 전파될 가능성이 상당히 높아진다.

DB가 하나인 경우는 말할 것도 없고 DB가 여러 개인 경우 각각의 트랜잭션에 대한 ack를 받아야 하는데 그런 경우 라이브 서비스에서는 그만큼 처리량이 나오지 않을 것이기 때문이다..

![이미지](/assets/images/Pasted%20image%2020260220153847.png)

그래서 큐를 사용해서 각 서버간의 물리적인 디커플링을 수행한다. 이렇게 하면 장애상황의 컨슈머가 안정적으로 복구되거나 증설되기 까지 큐가 가용성을 보장해 준다. 만약 실패한다고 하더라도 큐 안에 저장되어 있는 메세지를 특정 offset 부터 따라 읽어가면 복구 가능하다고 생각했다.

어떤곳은 SAGA 패턴을 사용하여 Undo 트랜잭션까지 만들어 결과적으로 트랜잭션이 보장되게끔 하는 사례를 소개한 것도 봤다.

그래서 본인도 큐를 만능 열쇠로 생각을 어렴풋이 하고 있었던 것 같은데 이번 메이플 백섭 사태를 보면서 (당연하겠지만) 큐가 만능이 아니었다는것을 깨달았다.

### 물리적으로는 분리되었을지라도..

![이미지](/assets/images/Pasted%20image%2020260220153853.png)

물리적으로는 분리되어 처리량과 속도에는 문제가 있을지라도 장애 전파를 막을 수 있지만 비즈니스적으로는 분리되어 있지 않을 것이다 라는 것을 깨달았다.

전 서버 통합 경매장을 만든 순간부터 비즈니스적으로 얽혀버려서 하나의 부분적인 롤백으로 완벽한 대처는 불가능해 졌다.

설령 모든 Redo 로그를 저장해놨다할 지라도 해당 거래 데이터가 다른 서버의 어딘가에 영향을 미치는 순간 완벽한 롤백 = 전 서버 롤백이 되어버렸다.

그러므로 특히 경매장이 통합 되어버린 상황에서 스카니아 서버만 부분적으로 롤백을 결정 했을 때에는 아이템 복제 문제가 충분히 있을 수 있지만 전 서버 롤백 보다는 해당 서버만 롤백하고 아이템 복사나 소실 같은 나머지 민원은 로그 보면서 **자체적인 운영 인력을 갈아넣어 처리하자**라는 의사결정을 내리지 않았을까..

아무튼 그래서 일단은 다 받아주고 나중에 처리한다 라는 식의 접근이 어떤 업무에서는(특히 은행 계정계) 상당히 위험할 수도 있겠다 라는 생각이 든 한주 였다….