---
title: 주식수 변동에 따른 가격 히스토리 갱신
date: 2024-09-12
tags:
  - 개발
  - 아키텍처
category:
  - 실무경험
  - 투자홈
---

### AS-IS

현재 매일 1년치 데이터를 upsert 중.

**사유**: 주식 수량·권리 변동 이벤트가 발생하더라도 어떤 종목에 이벤트가 발생했는지 현재로서는 감지할 방법이 없음.
- 공시 기준으로 주식분할·유무상증감자 이벤트를 수집하면 이론상 가능하나, 효력발생일 기준으로 별도 파싱 로직이 필요함.

**TO-BE (목표)**: 일별 데이터 기준으로 주식 수량이 변동된 종목에 한해 N년치를 재upsert하는 방식이 최선으로 판단.

---

### 주식 수량 변동 예시 (삼성전자)

**2018년 (액면분할 전)**

```json
{
    "date": "2018-02-12",
    "symbol": "005930",
    "name_ko": "삼성전자",
    "dividend_yield": 62.33596,
    "dps": 28500.0,
    "eps": 157967.0,
    "par_value": 5000.0,
    "bps": 1156530.0,
    "shares_listed": 128386500,
    "per": 0.2894275,
    "pbr": 0.03953205
}
```

**2024년 (액면분할 후)**

```json
{
    "date": "2024-09-12",
    "symbol": "005930",
    "name_ko": "삼성전자",
    "dividend_yield": 2.177979,
    "dps": 1444.0,
    "eps": 2131.0,
    "par_value": 100.0,
    "bps": 52002.0,
    "shares_listed": 5969783000,
    "per": 31.11215,
    "pbr": 1.274951
}
```

`par_value` 5000 → 100, `shares_listed` 약 1.28억 → 약 59.7억으로 변동.

---

### 한화증권 사례

코스콤과 SFTP 전용선으로 통신하는 구조로 추정. 종가 기준으로 유통 주식 수량 또는 액면가 데이터가 변경된 경우, 해당 종목의 데이터를 재적재하는 방식으로 운영 중이라고 함.

---

### 현재 문제점 및 결론

1. **딥서치 API 서버 안정성 문제**: 1년 이상의 가격 데이터를 요청하면 응답 불능 상태가 됨. 1년 미만이더라도 호출 빈도가 높으면 마찬가지.
2. **페이징 처리의 어려움**: 1년 단위로 분할 호출하는 방식도 가능하나, 현재 내부망 + EAI 구조로 인해 Kafka를 사용 중이라 페이징 호출 로직 구현이 복잡함.
   - 구조 개선이 필요하다면, 현재 프로젝트를 폐기하고 퍼블릭 망에서 신규 구축하는 것이 적절하다고 판단.

**결론**: 우선 3개월치 데이터를 무조건 upsert로 구현하고, 딥서치가 제공하는 기간별 집계 API를 호출하여 캐싱하는 방식으로 처리.
